# =====================================================
@router.delete("/{obligation_id}")
async def delete_obligation(
    obligation_id: int,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """
    Delete an obligation with proper cascading and UI refresh
    """
    try:
        logger.info(f"üóëÔ∏è Deleting obligation {obligation_id}")
        
        # Get the obligation first
        obligation = db.query(Obligation).filter(Obligation.id == obligation_id).first()
        
        if not obligation:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Obligation not found"
            )
        
        # Verify user has access
        contract = db.query(Contract).filter(Contract.id == obligation.contract_id).first()
        if contract and contract.company_id != current_user.company_id:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="Access denied"
            )
        
        # ‚úÖ DELETE RELATED RECORDS IN CORRECT ORDER
            # Disable FK checks temporarily
            db.execute(text("SET FOREIGN_KEY_CHECKS=0"))
        try:
            # Disable foreign key checks to force delete
            db.execute(text("SET FOREIGN_KEY_CHECKS=0"))
            # 1. Delete from obligation_updates
            db.execute(
                text("DELETE FROM obligation_updates WHERE obligation_id = :id"),
                {"id": obligation_id}
            )
            
            # 2. Delete from obligation_escalations
            db.execute(
                text("DELETE FROM obligation_escalations WHERE obligation_id = :id"),
                {"id": obligation_id}
            )
            
            # 3. Delete from obligation_tracking
            db.execute(
                text("DELETE FROM obligation_tracking WHERE obligation_id = :id"),
                {"id": obligation_id}
            )
            
            # 4. Delete from kpis table
            db.execute(
                text("DELETE FROM kpis WHERE obligation_id = :id"),
                {"id": obligation_id}
            )
            
            # 5. Finally, delete the obligation itself
            db.commit()
            logger.info(f"‚úÖ Deleted related records, now deleting obligation")
            
            # 5. Finally, delete the obligation itself
            db.delete(obligation)
            db.execute(text("SET FOREIGN_KEY_CHECKS=1"))
            db.commit()
            
            # Re-enable FK checks
            db.execute(text("SET FOREIGN_KEY_CHECKS=1"))
            logger.info(f"‚úÖ Obligation {obligation_id} deleted successfully")
            
            return {
                "success": True,
                "message": "Obligation deleted successfully",
                "id": obligation_id
            }
            
        except Exception as e:
            db.rollback()
            logger.error(f"‚ùå Error during cascading delete: {str(e)}")
            raise
        
    except HTTPException:
        raise
    except Exception as e:
        db.rollback()
        logger.error(f"‚ùå Error deleting obligation: {str(e)}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to delete obligation: {str(e)}"
        )




@router.post("/bulk-delete")
async def bulk_delete_obligations(
    request: dict,
    db: Session = Depends(get_db),
