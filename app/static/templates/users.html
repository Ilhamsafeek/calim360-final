{% extends "base.html" %}

{% block title %}User Management{% endblock %}

{% block head %}
<style>
    /* =====================================================
   USER MANAGEMENT - INLINE STYLES
   ===================================================== */

    .content-wrapper {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--border-color);
    }

    .header-left {
        flex: 1;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .page-title i {
        color: var(--primary-color);
        font-size: 2rem;
    }

    .page-subtitle {
        color: var(--text-muted);
        font-size: 0.95rem;
    }

    .header-right {
        display: flex;
        gap: 1rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.25rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        color: white;
    }

    .stat-icon.bg-primary {
        background: linear-gradient(135deg, #2762cb, #73B4E0);
    }

    .stat-icon.bg-success {
        background: linear-gradient(135deg, #28a745, #20c997);
    }

    .stat-icon.bg-warning {
        background: linear-gradient(135deg, #ffc107, #ff9800);
    }

    .stat-icon.bg-secondary {
        background: linear-gradient(135deg, #73B4E0, #0dcaf0);
    }

    .stat-content {
        flex: 1;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-color);
        line-height: 1;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    .filter-bar {
        background: white;
        padding: 1.25rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .search-box {
        flex: 1;
        position: relative;
        max-width: 400px;
    }

    .search-box i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 1.125rem;
    }

    .search-box input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 3rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.2s;
    }

    .search-box input:focus {
        outline: none;
        border-color: #2762cb;
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    .filter-controls {
        display: flex;
        gap: 0.75rem;
    }

    .filter-select {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.95rem;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-select:focus {
        outline: none;
        border-color: #2762cb;
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        overflow: hidden;
    }

    .card-body {
        padding: 0;
    }

    .table-container {
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
    }

    .data-table th {
        padding: 1rem;
        text-align: left;
        font-size: 0.875rem;
        font-weight: 600;
        color: #333;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-table tbody tr {
        border-bottom: 1px solid #e9ecef;
        transition: background 0.2s;
    }

    .data-table tbody tr:hover {
        background: #f8f9fa;
    }

    .data-table td {
        padding: 1rem;
        font-size: 0.95rem;
        color: #333;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2762cb, #73B4E0);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.95rem;
        flex-shrink: 0;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .user-details {
        flex: 1;
    }

    .user-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.125rem;
    }

    .user-role-badge {
        font-size: 0.75rem;
        color: #666;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        font-weight: 600;
    }

    .status-badge i {
        font-size: 0.875rem;
    }

    .status-badge.active {
        background: #d4edda;
        color: #28a745;
    }

    .status-badge.inactive {
        background: #f8d7da;
        color: #dc3545;
    }

    .status-badge.pending {
        background: #fff3cd;
        color: #856404;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1.125rem;
    }

    .btn-icon:hover {
        background: #2762cb;
        border-color: #2762cb;
        color: white;
    }

    .btn-icon.btn-danger:hover {
        background: #dc3545;
        border-color: #dc3545;
        color: white;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: #2762cb;
        color: white;
    }

    .btn-primary:hover {
        background: #1e4fa0;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(39, 98, 203, 0.3);
    }

    .btn-secondary {
        background: #f8f9fa;
        color: #333;
        border: 1px solid #e9ecef;
    }

    .btn-secondary:hover {
        background: #e9ecef;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    .modal-container {
        position: relative;
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 900px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
    }

    .modal-container.modal-sm {
        max-width: 500px;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #333;
    }

    .modal-title i {
        color: #2762cb;
        font-size: 1.75rem;
    }

    .modal-close {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        background: #f8f9fa;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .modal-close:hover {
        background: #e9ecef;
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-section.hidden {
        display: none;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e9ecef;
    }

    .section-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #2762cb, #73B4E0);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #333;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.25rem;
        margin-bottom: 1.25rem;
    }

    .form-row.single {
        grid-template-columns: 1fr;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .required {
        color: #dc3545;
    }

    .expert-required {
        color: #dc3545;
    }

    .form-input {
        padding: 0.75rem 1rem;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: #2762cb;
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    .required-field {
        border-left: 3px solid #2762cb;
    }

    .input-group {
        display: flex;
    }

    .input-prefix {
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-right: none;
        border-radius: 8px 0 0 8px;
        font-size: 0.95rem;
        color: #666;
        font-weight: 600;
    }

    .input-group .form-input {
        border-radius: 0 8px 8px 0;
    }

    .password-input-wrapper {
        position: relative;
    }

    .password-toggle {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: #666;
        font-size: 1.125rem;
        padding: 0.25rem;
    }

    .password-toggle:hover {
        color: #2762cb;
    }

    .form-hint {
        font-size: 0.8125rem;
        color: #666;
        margin-top: 0.375rem;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
        display: none;
    }

    .checkbox-custom {
        width: 20px;
        height: 20px;
        border: 2px solid #e9ecef;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .checkbox-label input[type="checkbox"]:checked+.checkbox-custom {
        background: #2762cb;
        border-color: #2762cb;
    }

    .checkbox-label input[type="checkbox"]:checked+.checkbox-custom::after {
        content: '‚úì';
        color: white;
        font-size: 0.875rem;
        font-weight: 700;
    }

    .checkbox-text {
        font-size: 0.95rem;
        color: #333;
    }

    .loading-row td {
        text-align: center;
        padding: 3rem;
    }

    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        color: #666;
        font-size: 1rem;
    }

    .loading-spinner i {
        font-size: 1.5rem;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
    }

    .empty-state i {
        font-size: 4rem;
        color: #666;
        opacity: 0.5;
        margin-bottom: 1rem;
    }

    .empty-state-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .empty-state-text {
        color: #666;
        margin-bottom: 1.5rem;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 1rem;
        min-width: 300px;
        max-width: 500px;
        z-index: 10000;
        opacity: 0;
        transform: translateX(400px);
        transition: all 0.3s ease-out;
    }

    .notification.show {
        opacity: 1;
        transform: translateX(0);
    }

    .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .notification-success .notification-icon {
        background: #d4edda;
        color: #28a745;
    }

    .notification-error .notification-icon {
        background: #f8d7da;
        color: #dc3545;
    }

    .notification-warning .notification-icon {
        background: #fff3cd;
        color: #856404;
    }

    .notification-info .notification-icon {
        background: #d1ecf1;
        color: #0c5460;
    }

    .notification-message {
        flex: 1;
        font-size: 0.95rem;
        color: #333;
        font-weight: 500;
    }

    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-danger {
        background: #f8d7da;
        color: #dc3545;
    }

    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }

    .badge-primary {
        background: rgba(39, 98, 203, 0.1);
        color: #2762cb;
    }

    .badge-secondary {
        background: rgba(115, 180, 224, 0.1);
        color: #73B4E0;
    }

    .badge-success {
        background: #d4edda;
        color: #28a745;
    }

    /* Hide elements based on role */
    .hidden-for-users {
        display: none !important;
    }

    @media (max-width: 768px) {
        .content-wrapper {
            padding: 1rem;
        }

        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .filter-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .search-box {
            max-width: 100%;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .modal-container {
            width: 95%;
            max-height: 95vh;
        }
    }

    /* Subscription Status Styling */
    #companySubscriptionStatus {
        font-weight: 600;
    }

    #companySubscriptionStatus[value*="Active"] {
        color: #28a745;
    }

    #companySubscriptionStatus[value*="Expired"],
    #companySubscriptionStatus[value*="Cancelled"] {
        color: #dc3545;
    }

    #companySubscriptionStatus[value*="Trial"],
    #companySubscriptionStatus[value*="Pending"] {
        color: #ffc107;
    }

    #companySubscriptionStatus[value*="Suspended"] {
        color: #6c757d;
    }

    /* License Type Styling */
    #companyLicenseType {
        font-weight: 600;
        color: #2762cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-left">
            <h1 class="page-title">
                <i class="ti ti-users"></i>
                User Management
            </h1>
            <p class="page-subtitle">Manage company users and their access</p>
        </div>
        <div class="header-right">
            <button class="btn btn-primary" id="addUserBtn">
                <i class="ti ti-plus"></i>
                Add New User
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-icon bg-primary">
                <i class="ti ti-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-success">
                <i class="ti ti-user-check"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="activeUsers">0</div>
                <div class="stat-label">Active Users</div>
            </div>
        </div>
        <div class="stat-card" id="pendingUsersCard">
            <div class="stat-icon bg-warning">
                <i class="ti ti-user-exclamation"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="pendingUsers">0</div>
                <div class="stat-label">Pending Verification</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-secondary">
                <i class="ti ti-certificate"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="expertUsers">0</div>
                <div class="stat-label">Expert Users</div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filter-bar">
        <div class="search-box">
            <i class="ti ti-search"></i>
            <input type="text" id="searchUsers" placeholder="Search users by name, email, or role...">
        </div>
        <div class="filter-controls">
            <select id="filterStatus" class="filter-select">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="pending">Pending</option>
            </select>
            <select id="filterRole" class="filter-select">
                <option value="">All Roles</option>
                <option value="admin">Administrator</option>
                <option value="manager">Manager</option>
                <option value="user">User</option>
                <option value="viewer">Viewer</option>
            </select>
            <select id="filterType" class="filter-select">
                <option value="">All Types</option>
                <option value="client">Client</option>
                <option value="consultant">Consultant</option>
                <option value="contractor">Contractor</option>
                <option value="sub_contractor">Sub-Contractor</option>
                <option value="expert">Expert</option>
            </select>
        </div>
    </div>

    <!-- Users Table -->
    <!-- Users Table -->
    <!-- Users Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-container">
                <table class="data-table" id="usersTable">
                    <thead>
                        <tr>
                            <th id="selectAllHeader">
                                <input type="checkbox" id="selectAll">
                            </th>
                            <th>User</th>
                            <th>Email</th>
                            <th id="companyHeader">Company</th> <!-- ‚úÖ ADDED ID for hiding -->
                            <th>Role</th>
                            <th>Type</th>
                            <th>Department</th>
                            <th id="statusHeader">Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr class="loading-row">
                            <td colspan="9">
                                <div class="loading-spinner">
                                    <i class="ti ti-loader-2"></i>
                                    Loading users...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div class="modal" id="userModal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">
                <span id="modalTitle">Add New User</span>
            </h2>
            <button class="modal-close" id="closeModalBtn">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="userForm">
                <input type="hidden" id="userId">

                <!-- Personal Information -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="ti ti-user"></i>
                        </div>
                        <div class="section-title">Personal Information</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                First Name <span class="required">*</span>
                            </label>
                            <input type="text" id="firstName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Last Name <span class="required">*</span>
                            </label>
                            <input type="text" id="lastName" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Email Address <span class="required">*</span>
                            </label>
                            <input type="email" id="email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Mobile Number <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-prefix">+974</span>
                                <input type="tel" id="mobileNumber" class="form-input" placeholder="33334444" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">QID Number</label>
                            <input type="text" id="qidNumber" class="form-input" maxlength="11">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Job Title</label>
                            <input type="text" id="jobTitle" class="form-input">
                        </div>
                    </div>
                </div>


                <!-- ‚úÖ ADD THIS COMPANY SECTION HERE -->
                <div class="form-section hidden" id="companyInfoSection">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="ti ti-building-skyscraper"></i>
                        </div>
                        <div class="section-title">Company Information</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" id="companyName" class="form-input" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company Type</label>
                            <input type="text" id="companyType" class="form-input" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">CR Number</label>
                            <input type="text" id="companyCrNumber" class="form-input" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">License Type</label>
                            <input type="text" id="companyLicenseType" class="form-input" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Maximum Users</label>
                            <input type="text" id="companyMaxUsers" class="form-input" readonly>
                        </div>
                    </div>


                </div>

                <!-- Account Information -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="ti ti-shield-lock"></i>
                        </div>
                        <div class="section-title">Account Information</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Username <span class="required">*</span>
                            </label>
                            <input type="text" id="username" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                User Role <span class="required">*</span>
                            </label>
                            <select id="userRole" class="form-input" required>
                                <option value="">Select Role</option>
                                <option value="admin">Administrator</option>
                                <option value="manager">Manager</option>
                                <option value="user">User</option>
                                <option value="viewer">Viewer</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Password <span class="required" id="passwordRequired">*</span>
                            </label>
                            <div class="password-input-wrapper">
                                <input type="password" id="password" class="form-input" required>
                                <button type="button" class="password-toggle" id="togglePassword">
                                    <i class="ti ti-eye"></i>
                                </button>
                            </div>
                            <small class="form-hint">Minimum 8 characters with uppercase, lowercase, and number</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Confirm Password <span class="required" id="confirmPasswordRequired">*</span>
                            </label>
                            <div class="password-input-wrapper">
                                <input type="password" id="confirmPassword" class="form-input" required>
                                <button type="button" class="password-toggle" id="toggleConfirmPassword">
                                    <i class="ti ti-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Organizational Information -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="ti ti-building"></i>
                        </div>
                        <div class="section-title">Organizational Information</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <select id="department" class="form-input">
                                <option value="">Select Department</option>
                                <option value="legal">Legal</option>
                                <option value="procurement">Procurement</option>
                                <option value="finance">Finance</option>
                                <option value="operations">Operations</option>
                                <option value="hr">Human Resources</option>
                                <option value="it">IT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">User Type <span class="required">*</span></label>
                            <select id="userType" class="form-input" required>
                                <option value="">Select Type</option>
                                <option value="client">Client</option>
                                <option value="consultant">Consultant</option>
                                <option value="contractor">Contractor</option>
                                <option value="sub_contractor">Sub-Contractor</option>
                                <option value="expert">Expert</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Expert Profile Section (Hidden by default) -->
                <div class="form-section hidden" id="expertProfileSection">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="ti ti-certificate"></i>
                        </div>
                        <div class="section-title">Expert Profile Information</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Specialization <span class="expert-required">*</span>
                            </label>
                            <input type="text" id="specialization" class="form-input"
                                placeholder="e.g., Construction Law, QFCRA Compliance">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Years of Experience <span class="expert-required">*</span>
                            </label>
                            <input type="number" id="yearsOfExperience" class="form-input" min="0" max="50">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">License Number</label>
                            <input type="text" id="licenseNumber" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">License Authority</label>
                            <input type="text" id="licenseAuthority" class="form-input"
                                placeholder="e.g., Qatar Bar Association">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Hourly Rate (QAR) <span class="expert-required">*</span>
                            </label>
                            <input type="number" id="hourlyRate" class="form-input" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Expertise Areas <span class="expert-required">*</span>
                            </label>
                            <input type="text" id="expertiseAreas" class="form-input"
                                placeholder="QFCRA, Construction, Arbitration">
                            <small class="form-hint">Separate multiple areas with commas</small>
                        </div>
                    </div>

                    <div class="form-row single">
                        <div class="form-group">
                            <label class="form-label">Professional Bio</label>
                            <textarea id="bio" class="form-input" rows="4"
                                placeholder="Brief description of expertise and experience"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="qfcraCertified">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">QFCRA Certified</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="qidVerified">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">QID Verified</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-row single">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="isAvailable" checked>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Available for Consultations</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Preferences -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="ti ti-settings"></i>
                        </div>
                        <div class="section-title">Preferences</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Language Preference</label>
                            <select id="languagePreference" class="form-input">
                                <option value="en" selected>English</option>
                                <option value="ar">Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Timezone</label>
                            <select id="timezone" class="form-input">
                                <option value="Asia/Qatar" selected>Qatar (GMT+3)</option>
                                <option value="Asia/Dubai">Dubai (GMT+4)</option>
                                <option value="Asia/Riyadh">Riyadh (GMT+3)</option>
                                <option value="Europe/London">London (GMT+0)</option>
                                <option value="America/New_York">New York (GMT-5)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row single">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="isActive" checked>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Active User (User can log in immediately)</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-row single">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="sendWelcomeEmail" checked>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Send welcome email with login credentials</span>
                            </label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveUserBtn">
                <i class="ti ti-check"></i>
                Save User
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-overlay"></div>
    <div class="modal-container modal-sm">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="ti ti-alert-triangle" style="color: #dc3545;"></i>
                Confirm Delete
            </h2>
            <button class="modal-close" id="closeDeleteModalBtn">
                <i class="ti ti-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this user? This action cannot be undone.</p>
            <div class="user-delete-info" id="deleteUserInfo"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                <i class="ti ti-trash"></i>
                Delete User
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    /* =====================================================
       USER MANAGEMENT - COMPLETE INLINE JAVASCRIPT
       ===================================================== */

    let allUsers = [];
    let currentUserId = null;
    let currentUserRole = null;
    let isInternalUser = false; // ‚úÖ Track if user is internal

    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ User Management initialized');
        initializeUserManagement();
    });

    async function initializeUserManagement() {
        await getCurrentUserRole(); // Get current user's role first

        // // ‚úÖ NEW: Load companies if internal user
        // if (isInternalUser) {
        //     await loadCompanies();
        // }

        loadUsers();
        setupEventListeners();
        updateUIBasedOnRole(); // Update UI based on role
    }

    // ‚úÖ UPDATED: Get current user role AND check if internal
    async function getCurrentUserRole() {
        try {
            // Try primary endpoint first
            let response = await fetch('/api/auth/me', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            // If 422, try alternative endpoint
            if (response.status === 422) {
                console.log('‚ö†Ô∏è /api/auth/me returned 422, trying /api/users/debug/current-user');
                response = await fetch('/api/users/debug/current-user', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
            }

            if (response.ok) {
                const data = await response.json();
                console.log('üì¶ User data:', data);

                // Extract role and type from various possible structures
                const user = data.user || data;
                currentUserRole = user.user_role || user.role || 'viewer';
                isInternalUser = user.user_type === 'internal'; // ‚úÖ Check if internal

                console.log('üë§ Current user role:', currentUserRole);
                console.log('üè¢ Is internal user:', isInternalUser);
            } else {
                console.error('‚ùå Auth check failed, status:', response.status);
                currentUserRole = 'viewer';
                isInternalUser = false;
            }
        } catch (error) {
            console.error('‚ùå Error getting current user role:', error);
            currentUserRole = 'viewer';
            isInternalUser = false;
        }
    }

    // Check if user has permission to manage users
    function canManageUsers() {
        return currentUserRole === 'admin' || currentUserRole === 'manager';
    }

    // ‚úÖ UPDATED: Hide company column for non-internal users
    function updateUIBasedOnRole() {
        const addUserBtn = document.getElementById('addUserBtn');
        const statusHeader = document.getElementById('statusHeader');
        const selectAllHeader = document.getElementById('selectAllHeader');
        const filterStatus = document.getElementById('filterStatus');
        const pendingUsersCard = document.getElementById('pendingUsersCard');
        const companyHeader = document.getElementById('companyHeader');

        if (!canManageUsers()) {
            // Hide add user button for non-admin/manager
            if (addUserBtn) {
                addUserBtn.style.display = 'none';
            }

            // Hide status column header
            if (statusHeader) {
                statusHeader.classList.add('hidden-for-users');
            }

            // Hide select all checkbox header
            if (selectAllHeader) {
                selectAllHeader.classList.add('hidden-for-users');
            }

            // Hide status filter
            if (filterStatus) {
                filterStatus.parentElement.style.display = 'none';
            }

            // Hide pending users stat card
            if (pendingUsersCard) {
                pendingUsersCard.style.display = 'none';
            }
        }

        // ‚úÖ NEW: Hide company column for non-internal users
        if (!isInternalUser && companyHeader) {
            companyHeader.classList.add('hidden-for-users');
        }
    }

    // ‚úÖ NEW: Load all companies for internal users with license info
    async function loadCompanies() {
        try {
            const response = await fetch('/api/companies/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                const companies = data.companies || data.data || [];

                const companySelect = document.getElementById('companyId');
                companySelect.innerHTML = '<option value="">Select Company</option>';

                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.company_name;

                    // Store all company data as data attributes
                    option.dataset.type = company.company_type || '';
                    option.dataset.crNumber = company.cr_number || '';
                    option.dataset.taxNumber = company.tax_number || '';
                    option.dataset.address = company.address || '';

                    // ‚úÖ License and subscription data
                    option.dataset.licenseType = company.license_type || '';
                    option.dataset.maxUsers = company.max_users || company.number_of_users || '';
                    option.dataset.subscriptionStatus = company.subscription_status || '';
                    option.dataset.subscriptionEnd = company.subscription_end_date || '';

                    companySelect.appendChild(option);
                });

                console.log(`‚úÖ Loaded ${companies.length} companies`);
            }
        } catch (error) {
            console.error('‚ùå Error loading companies:', error);
        }
    }

    // ‚úÖ NEW: Helper function to format license type
    function formatLicenseType(licenseType) {
        const typeMap = {
            'basic': 'Basic Plan',
            'professional': 'Professional Plan',
            'enterprise': 'Enterprise Plan',
            'trial': 'Trial',
            'starter': 'Starter Plan',
            'premium': 'Premium Plan'
        };
        return typeMap[licenseType?.toLowerCase()] || licenseType || 'N/A';
    }

    // ‚úÖ NEW: Helper function to format subscription status
    function formatSubscriptionStatus(status) {
        const statusMap = {
            'active': '‚úì Active',
            'expired': '‚úó Expired',
            'trial': '‚è± Trial',
            'suspended': '‚è∏ Suspended',
            'cancelled': '‚úó Cancelled',
            'pending': '‚è≥ Pending'
        };
        return statusMap[status?.toLowerCase()] || status || 'N/A';
    }

    // ‚úÖ NEW: Helper function to format date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        } catch (e) {
            return dateString;
        }
    }

    // ‚úÖ NEW: Load complete company data for selected user
    async function loadCompanyData(companyId) {
        try {
            console.log('üè¢ Loading company data for ID:', companyId);

            const response = await fetch(`/api/companies/${companyId}`, {
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });

            if (response.ok) {
                const company = await response.json();

                // ‚úÖ SHOW ME ALL FIELD NAMES
                console.log('=== ALL COMPANY FIELDS ===');
                console.log(JSON.stringify(company, null, 2));
                console.log('=== FIELD NAMES ===');
                console.log(Object.keys(company));

                // ‚úÖ Helper function to safely set value
                function safeSetValue(elementId, value) {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = value || '';
                    } else {
                        console.warn(`‚ö†Ô∏è Element not found: ${elementId}`);
                    }
                }

                // ‚úÖ Set company name (no dropdown, just readonly field)
                safeSetValue('companyName', company.company_name);

                // Basic fields
                safeSetValue('companyType', company.company_type);
                safeSetValue('companyCrNumber', company.cr_number);
                safeSetValue('companyTaxNumber', company.tax_number);
                safeSetValue('companyAddress', company.address);

                // ‚úÖ Try all possible field names
                const licenseType = company.license_type || company.licence_type ||
                    company.subscription_type || company.plan_type ||
                    company.subscription_plan || company.plan || '';

                const maxUsers = company.max_users || company.number_of_users ||
                    company.user_limit || company.allowed_users ||
                    company.total_users || '';

                const subStatus = company.subscription_status || company.status ||
                    company.account_status || company.plan_status || '';

                const subEnd = company.subscription_end_date || company.expiry_date ||
                    company.subscription_expiry || company.valid_until ||
                    company.end_date || company.expires_at || '';

                safeSetValue('companyLicenseType', formatLicenseType(licenseType));
                safeSetValue('companyMaxUsers', maxUsers || 'N/A');
                safeSetValue('companySubscriptionStatus', formatSubscriptionStatus(subStatus));
                safeSetValue('companySubscriptionEnd', subEnd ? formatDate(subEnd) : 'N/A');

                console.log('‚úÖ License Type:', licenseType);
                console.log('‚úÖ Max Users:', maxUsers);
                console.log('‚úÖ Status:', subStatus);
                console.log('‚úÖ End Date:', subEnd);
            }
        } catch (error) {
            console.error('‚ùå Error:', error);
        }
    }

    function setupEventListeners() {
        document.getElementById('addUserBtn').addEventListener('click', () => {
            if (canManageUsers()) {
                openUserModal();
            } else {
                showNotification('You do not have permission to add users', 'error');
            }
        });

        document.getElementById('closeModalBtn').addEventListener('click', closeUserModal);
        document.getElementById('cancelBtn').addEventListener('click', closeUserModal);
        document.getElementById('closeDeleteModalBtn').addEventListener('click', closeDeleteModal);
        document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteModal);

        document.getElementById('saveUserBtn').addEventListener('click', saveUser);
        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteUser);

        document.getElementById('searchUsers').addEventListener('input', filterUsers);
        document.getElementById('filterStatus').addEventListener('change', filterUsers);
        document.getElementById('filterRole').addEventListener('change', filterUsers);
        document.getElementById('filterType').addEventListener('change', filterUsers);

        document.getElementById('togglePassword').addEventListener('click', togglePasswordVisibility);
        document.getElementById('toggleConfirmPassword').addEventListener('click', toggleConfirmPasswordVisibility);

        document.getElementById('selectAll').addEventListener('change', toggleSelectAll);

        // Show/hide expert profile section based on user type
        document.getElementById('userType').addEventListener('change', function () {
            const expertSection = document.getElementById('expertProfileSection');
            const userType = this.value;

            if (userType === 'expert') {
                expertSection.classList.remove('hidden');
                setExpertFieldsRequired(true);
            } else {
                expertSection.classList.add('hidden');
                setExpertFieldsRequired(false);
            }
        });



        // Auto-generate username from email
        document.getElementById('email').addEventListener('input', function () {
            if (!document.getElementById('userId').value) {
                document.getElementById('username').value = this.value.split('@')[0];
            }
        });

        document.querySelector('#userModal .modal-overlay').addEventListener('click', closeUserModal);
        document.querySelector('#deleteModal .modal-overlay').addEventListener('click', closeDeleteModal);
    }

    // Function to set expert fields as required/optional
    function setExpertFieldsRequired(required) {
        const expertFields = [
            'specialization',
            'yearsOfExperience',
            'hourlyRate',
            'expertiseAreas'
        ];

        expertFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.required = required;

                // Add visual indicator
                if (required) {
                    field.classList.add('required-field');
                } else {
                    field.classList.remove('required-field');
                }
            }
        });
    }

    async function loadUsers() {
        try {
            const response = await fetch('/api/users/company', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (response.status === 401 || response.status === 403) {
                window.location.href = '/login?redirect=/users';
                return;
            }

            if (!response.ok) {
                throw new Error('Failed to load users');
            }

            const data = await response.json();
            // Filter out deleted users (is_active = False with .deleted in email)
            let users = (data.users || []).filter(u => !u.email.includes('.deleted'));

            // If not admin/manager, filter to show only active users
            if (!canManageUsers()) {
                users = users.filter(u => u.is_active && u.is_verified);
                console.log('üìä Filtered to active users only:', users.length);
            }

            allUsers = users;

            updateStats(users);
            renderUsers(users);
        } catch (error) {
            console.error('‚ùå Error loading users:', error);
            showNotification('Failed to load users. Please try logging in again.', 'error');
            renderEmptyState();
        }
    }

    function updateStats(users) {
        const totalUsers = users.length;
        const activeUsers = users.filter(u => u.is_active && u.is_verified).length;
        const pendingUsers = users.filter(u => !u.is_verified).length;
        const expertUsers = users.filter(u => u.user_type === 'expert').length;

        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('activeUsers').textContent = activeUsers;
        document.getElementById('pendingUsers').textContent = pendingUsers;
        document.getElementById('expertUsers').textContent = expertUsers;
    }

    // ‚úÖ UPDATED: Conditionally show company column for internal users only
    function renderUsers(users) {
        const tbody = document.getElementById('usersTableBody');

        if (users.length === 0) {
            renderEmptyState();
            return;
        }

        // Check if user can manage users
        const hasManagePermission = canManageUsers();

        // ‚úÖ Calculate colspan based on role AND internal status
        let totalColumns = 7; // Base columns (User, Email, Role, Type, Department, Actions)
        if (hasManagePermission) totalColumns++; // Add checkbox column
        if (hasManagePermission) totalColumns++; // Add status column
        if (isInternalUser) totalColumns++; // Add company column for internal users

        tbody.innerHTML = users.map(user => `
        <tr>
            ${hasManagePermission ? `
            <td>
                <input type="checkbox" class="user-checkbox" value="${user.id}">
            </td>
            ` : ''}
            <td>
                <div class="user-info">
                    <div class="user-avatar">
                        ${getInitials(user.first_name, user.last_name)}
                    </div>
                    <div class="user-details">
                        <div class="user-name">${user.first_name} ${user.last_name}</div>
                        <div class="user-role-badge">${user.job_title || 'N/A'}</div>
                    </div>
                </div>
            </td>
            <td>${user.email}</td>
            ${isInternalUser ? `
            <!-- ‚úÖ CONDITIONAL: Only show company for internal users -->
            <td>
                <span class="badge badge-secondary" style="font-size: 0.8rem;">
                    ${user.company_name || 'N/A'}
                </span>
            </td>
            ` : ''}
            <td>
                <span class="badge badge-${getRoleBadgeColor(user.user_role)}">
                    ${formatRole(user.user_role)}
                </span>
            </td>
            <td>
                <span class="badge badge-${getTypeBadgeColor(user.user_type)}">
                    ${formatType(user.user_type)}
                </span>
            </td>
            <td>${user.department || 'N/A'}</td>
            ${hasManagePermission ? `
            <td>
                ${renderStatusBadge(user)}
            </td>
            ` : ''}
            <td>
                ${hasManagePermission ? `
                <div class="action-buttons">
                    <button class="btn-icon" onclick="editUser(${user.id})" title="Edit">
                        <i class="ti ti-edit"></i>
                    </button>
                    <button class="btn-icon btn-danger" onclick="confirmDeleteUser(${user.id}, '${user.first_name} ${user.last_name}')" title="Delete">
                        <i class="ti ti-trash"></i>
                    </button>
                </div>
                ` : `
                <span style="color: #999; font-size: 0.875rem;">View Only</span>
                `}
            </td>
        </tr>
    `).join('');
    }

    // ‚úÖ UPDATED: Dynamic colspan calculation
    function renderEmptyState() {
        const tbody = document.getElementById('usersTableBody');
        const hasManagePermission = canManageUsers();

        // ‚úÖ Calculate total columns dynamically
        let totalColumns = 7; // Base columns
        if (hasManagePermission) totalColumns++; // Add checkbox column
        if (hasManagePermission) totalColumns++; // Add status column
        if (isInternalUser) totalColumns++; // Add company column for internal users

        tbody.innerHTML = `
        <tr>
            <td colspan="${totalColumns}">
                <div class="empty-state">
                    <i class="ti ti-users-off"></i>
                    <div class="empty-state-title">No Users Found</div>
                    <div class="empty-state-text">
                        ${hasManagePermission ? 'Get started by adding your first user to the system.' : 'No users available to display.'}
                    </div>
                    ${hasManagePermission ? `
                    <button class="btn btn-primary" onclick="openUserModal()">
                        <i class="ti ti-plus"></i>
                        Add First User
                    </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `;
    }

    function getInitials(firstName, lastName) {
        return `${firstName?.charAt(0) || ''}${lastName?.charAt(0) || ''}`.toUpperCase();
    }

    function getRoleBadgeColor(role) {
        const colors = {
            'admin': 'danger',
            'manager': 'warning',
            'user': 'primary',
            'viewer': 'secondary'
        };
        return colors[role] || 'secondary';
    }

    function getTypeBadgeColor(type) {
        const colors = {
            'expert': 'success',
            'consultant': 'primary',
            'contractor': 'warning',
            'client': 'secondary',
            'sub_contractor': 'warning'
        };
        return colors[type] || 'secondary';
    }

    function formatRole(role) {
        if (!role) return 'User';
        return role.charAt(0).toUpperCase() + role.slice(1);
    }

    function formatType(type) {
        if (!type) return 'N/A';
        if (type === 'sub_contractor') return 'Sub-Contractor';
        return type.charAt(0).toUpperCase() + type.slice(1);
    }

    function renderStatusBadge(user) {
        if (user.is_active && user.is_verified) {
            return '<span class="status-badge active"><i class="ti ti-check"></i> Active</span>';
        } else if (!user.is_verified) {
            return '<span class="status-badge pending"><i class="ti ti-clock"></i> Email Activation Pending</span>';
        } else {
            return '<span class="status-badge inactive"><i class="ti ti-x"></i> Inactive</span>';
        }
    }

    function openUserModal(userId = null) {
        if (!canManageUsers()) {
            showNotification('You do not have permission to manage users', 'error');
            return;
        }

        currentUserId = userId;
        const modal = document.getElementById('userModal');
        const modalTitle = document.getElementById('modalTitle');
        const expertSection = document.getElementById('expertProfileSection');
        const companySection = document.getElementById('companyInfoSection');
        const passwordField = document.getElementById('password');
        const confirmPasswordField = document.getElementById('confirmPassword');
        const passwordRequired = document.getElementById('passwordRequired');
        const confirmPasswordRequired = document.getElementById('confirmPasswordRequired');

        // ‚úÖ Show/hide company section for internal users
        if (companySection) {
            if (isInternalUser) {
                companySection.classList.remove('hidden');
                const companyIdField = document.getElementById('companyId');
                if (companyIdField) companyIdField.required = true;
            } else {
                companySection.classList.add('hidden');
                const companyIdField = document.getElementById('companyId');
                if (companyIdField) companyIdField.required = false;
            }
        }

        if (userId) {
            modalTitle.innerHTML = '<i class="ti ti-user-edit"></i> Edit User';
            passwordField.required = false;
            confirmPasswordField.required = false;
            passwordRequired.style.display = 'none';
            confirmPasswordRequired.style.display = 'none';
            passwordField.placeholder = 'Leave blank to keep current password';
            confirmPasswordField.placeholder = 'Leave blank to keep current password';
            loadUserData(userId);
        } else {
            modalTitle.innerHTML = '<i class="ti ti-user-plus"></i> Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            expertSection.classList.add('hidden');
            setExpertFieldsRequired(false);
            passwordField.required = true;
            confirmPasswordField.required = true;
            passwordRequired.style.display = 'inline';
            confirmPasswordRequired.style.display = 'inline';
            passwordField.placeholder = '';
            confirmPasswordField.placeholder = '';
        }

        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeUserModal() {
        const modal = document.getElementById('userModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
        document.getElementById('userForm').reset();
        document.getElementById('expertProfileSection').classList.add('hidden');
        setExpertFieldsRequired(false);
        currentUserId = null;
    }

    async function loadUserData(userId) {
        try {
            console.log('üîç Loading user data for ID:', userId);

            const response = await fetch(`/api/users/${userId}`, {
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            console.log('üì° Response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå API Error:', errorText);
                throw new Error('Failed to load user data');
            }

            const result = await response.json();
            console.log('üì¶ Full API Response:', result);

            // Handle both response formats
            const user = result.data || result;
            console.log('üë§ User object:', user);

            // Populate basic user fields
            document.getElementById('userId').value = user.id;
            document.getElementById('firstName').value = user.first_name || '';
            document.getElementById('lastName').value = user.last_name || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('mobileNumber').value = user.mobile_number || '';
            document.getElementById('qidNumber').value = user.qid_number || '';
            document.getElementById('jobTitle').value = user.job_title || '';
            document.getElementById('username').value = user.username || '';
            document.getElementById('userRole').value = user.user_role || '';
            document.getElementById('department').value = user.department || '';
            document.getElementById('userType').value = user.user_type || '';
            document.getElementById('languagePreference').value = user.language_preference || 'en';
            document.getElementById('timezone').value = user.timezone || 'Asia/Qatar';
            document.getElementById('isActive').checked = user.is_active !== false;

            // ‚úÖ NEW: Load company data for internal users
            if (isInternalUser && user.company_id) {
                await loadCompanyData(user.company_id);
            }

            console.log('‚úÖ All form fields populated');

            // Load expert profile if user is an expert
            if (user.user_type === 'expert') {
                console.log('üéì User is expert type, loading expert profile...');
                document.getElementById('expertProfileSection').classList.remove('hidden');
                setExpertFieldsRequired(true);
                await loadExpertProfile(user.id);
            } else {
                console.log('‚ÑπÔ∏è User is not expert type');
                document.getElementById('expertProfileSection').classList.add('hidden');
                setExpertFieldsRequired(false);
            }

        } catch (error) {
            console.error('‚ùå Error loading user data:', error);
            showNotification('Failed to load user data: ' + error.message, 'error');
        }
    }

    async function loadExpertProfile(userId) {
        try {
            console.log('üéì Fetching expert profile for user:', userId);

            const response = await fetch(`/api/users/expert-profiles/${userId}`, {
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            console.log('üì° Expert profile response status:', response.status);

            if (response.ok) {
                const profile = await response.json();
                console.log('üìã Expert profile data:', profile);

                // Populate expert profile fields
                document.getElementById('specialization').value = profile.specialization || '';
                document.getElementById('yearsOfExperience').value = profile.years_of_experience || '';
                document.getElementById('licenseNumber').value = profile.license_number || '';
                document.getElementById('licenseAuthority').value = profile.license_authority || '';
                document.getElementById('hourlyRate').value = profile.hourly_rate || '';
                document.getElementById('expertiseAreas').value = profile.expertise_areas || '';
                document.getElementById('bio').value = profile.bio || '';
                document.getElementById('qfcraCertified').checked = profile.qfcra_certified || false;
                document.getElementById('qidVerified').checked = profile.qid_verified || false;
                document.getElementById('isAvailable').checked = profile.is_available !== false;

                console.log('‚úÖ Expert profile fields populated');
            } else {
                console.log('‚ÑπÔ∏è No expert profile found');
            }
        } catch (error) {
            console.log('‚ÑπÔ∏è No existing expert profile:', error.message);
        }
    }

    async function saveUser(e) {
        e.preventDefault();

        // Check permission
        if (!canManageUsers()) {
            showNotification('You do not have permission to manage users', 'error');
            return;
        }

        if (!validateForm()) {
            return;
        }

        const formData = {
            first_name: document.getElementById('firstName').value.trim(),
            last_name: document.getElementById('lastName').value.trim(),
            email: document.getElementById('email').value.trim(),
            mobile_number: document.getElementById('mobileNumber').value.trim(),
            qid_number: document.getElementById('qidNumber').value.trim() || null,
            job_title: document.getElementById('jobTitle').value.trim() || null,
            username: document.getElementById('username').value.trim(),
            user_role: document.getElementById('userRole').value,
            department: document.getElementById('department').value || null,
            user_type: document.getElementById('userType').value || null,
            language_preference: document.getElementById('languagePreference').value,
            timezone: document.getElementById('timezone').value,
            is_active: document.getElementById('isActive').checked,
            send_welcome_email: document.getElementById('sendWelcomeEmail').checked
        };

        // ‚úÖ NEW: Add company_id for internal users
        if (isInternalUser) {
            const companyId = document.getElementById('companyId').value;
            if (!companyId) {
                showNotification('Please select a company', 'error');
                return;
            }
            formData.company_id = parseInt(companyId);
        }

        // Add password if provided
        const password = document.getElementById('password').value;
        if (password) {
            formData.password = password;
        }

        // Add expert profile data if user type is expert
        if (formData.user_type === 'expert') {
            formData.expert_profile = {
                specialization: document.getElementById('specialization').value.trim() || null,
                years_of_experience: document.getElementById('yearsOfExperience').value ? parseInt(document.getElementById('yearsOfExperience').value) : null,
                license_number: document.getElementById('licenseNumber').value.trim() || null,
                license_authority: document.getElementById('licenseAuthority').value.trim() || null,
                hourly_rate: document.getElementById('hourlyRate').value ? parseFloat(document.getElementById('hourlyRate').value) : null,
                expertise_areas: document.getElementById('expertiseAreas').value.trim() || null,
                bio: document.getElementById('bio').value.trim() || null,
                qfcra_certified: document.getElementById('qfcraCertified').checked,
                qid_verified: document.getElementById('qidVerified').checked,
                is_available: document.getElementById('isAvailable').checked
            };
        }

        try {
            const url = currentUserId
                ? `/api/users/${currentUserId}`
                : '/api/users/create';

            const method = currentUserId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save user');
            }

            const result = await response.json();

            showNotification(
                currentUserId ? 'User updated successfully' : 'User created successfully',
                'success'
            );

            closeUserModal();
            await loadUsers();

        } catch (error) {
            console.error('‚ùå Error saving user:', error);
            showNotification(error.message, 'error');
        }
    }

    function validateForm() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // Only validate password if it's provided
        if (password || confirmPassword) {
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return false;
            }

            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;
            if (!passwordRegex.test(password)) {
                showNotification(
                    'Password must be at least 8 characters with uppercase, lowercase, and number',
                    'error'
                );
                return false;
            }
        }

        const email = document.getElementById('email').value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showNotification('Please enter a valid email address', 'error');
            return false;
        }

        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const username = document.getElementById('username').value.trim();
        const userRole = document.getElementById('userRole').value;
        const userType = document.getElementById('userType').value;

        if (!firstName || !lastName || !username || !userRole) {
            showNotification('Please fill in all required fields', 'error');
            return false;
        }

        // Validate expert profile fields if user type is expert
        if (userType === 'expert') {
            const specialization = document.getElementById('specialization').value.trim();
            const yearsOfExperience = document.getElementById('yearsOfExperience').value;
            const hourlyRate = document.getElementById('hourlyRate').value;
            const expertiseAreas = document.getElementById('expertiseAreas').value.trim();

            if (!specialization) {
                showNotification('Please enter specialization for expert profile', 'error');
                return false;
            }

            if (!yearsOfExperience) {
                showNotification('Please enter years of experience for expert profile', 'error');
                return false;
            }

            if (!hourlyRate) {
                showNotification('Please enter hourly rate for expert profile', 'error');
                return false;
            }

            if (!expertiseAreas) {
                showNotification('Please enter expertise areas for expert profile', 'error');
                return false;
            }

            // Validate years of experience range
            const years = parseInt(yearsOfExperience);
            if (years < 0 || years > 50) {
                showNotification('Years of experience must be between 0 and 50', 'error');
                return false;
            }

            // Validate hourly rate is positive
            const rate = parseFloat(hourlyRate);
            if (rate <= 0) {
                showNotification('Hourly rate must be greater than 0', 'error');
                return false;
            }
        }

        return true;
    }

    function confirmDeleteUser(userId, userName) {
        // Check permission
        if (!canManageUsers()) {
            showNotification('You do not have permission to delete users', 'error');
            return;
        }

        currentUserId = userId;
        document.getElementById('deleteUserInfo').innerHTML = `
        <p style="margin-top: 1rem;"><strong>${userName}</strong></p>
        <p style="color: #666; margin-top: 0.5rem;">This will permanently delete this user and all associated data.</p>
    `;
        document.getElementById('deleteModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
        document.body.style.overflow = '';
        currentUserId = null;
    }

    async function deleteUser() {
        if (!currentUserId) return;

        // Check permission
        if (!canManageUsers()) {
            showNotification('You do not have permission to delete users', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/users/${currentUserId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (!response.ok) throw new Error('Failed to delete user');

            showNotification('User deleted successfully', 'success');
            closeDeleteModal();
            await loadUsers();

        } catch (error) {
            console.error('‚ùå Error deleting user:', error);
            showNotification('Failed to delete user', 'error');
        }
    }

    function filterUsers() {
        const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
        const statusFilter = document.getElementById('filterStatus').value;
        const roleFilter = document.getElementById('filterRole').value;
        const typeFilter = document.getElementById('filterType').value;

        let filteredUsers = allUsers.filter(user => {
            const matchesSearch =
                user.first_name.toLowerCase().includes(searchTerm) ||
                user.last_name.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm) ||
                (user.job_title && user.job_title.toLowerCase().includes(searchTerm)) ||
                (user.username && user.username.toLowerCase().includes(searchTerm));

            const matchesStatus = !statusFilter ||
                (statusFilter === 'active' && user.is_active && user.is_verified) ||
                (statusFilter === 'inactive' && (!user.is_active || !user.is_verified)) ||
                (statusFilter === 'pending' && !user.is_verified);

            const matchesRole = !roleFilter || user.user_role === roleFilter;
            const matchesType = !typeFilter || user.user_type === typeFilter;

            return matchesSearch && matchesStatus && matchesRole && matchesType;
        });

        renderUsers(filteredUsers);
    }

    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('password');
        const icon = document.querySelector('#togglePassword i');

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('ti-eye');
            icon.classList.add('ti-eye-off');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('ti-eye-off');
            icon.classList.add('ti-eye');
        }
    }

    function toggleConfirmPasswordVisibility() {
        const passwordInput = document.getElementById('confirmPassword');
        const icon = document.querySelector('#toggleConfirmPassword i');

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('ti-eye');
            icon.classList.add('ti-eye-off');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('ti-eye-off');
            icon.classList.add('ti-eye');
        }
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.user-checkbox');

        checkboxes.forEach(checkbox => {
            if (!checkbox.disabled) {
                checkbox.checked = selectAll.checked;
            }
        });
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;

        const iconClass = type === 'success' ? 'ti-check' :
            type === 'error' ? 'ti-alert-circle' :
                type === 'warning' ? 'ti-alert-triangle' : 'ti-info-circle';

        notification.innerHTML = `
        <div class="notification-icon">
            <i class="ti ${iconClass}"></i>
        </div>
        <div class="notification-message">${message}</div>
    `;

        document.body.appendChild(notification);

        setTimeout(() => notification.classList.add('show'), 10);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }

    // Global functions for onclick handlers
    window.editUser = function (userId) {
        openUserModal(userId);
    };

    window.confirmDeleteUser = confirmDeleteUser;
    window.openUserModal = openUserModal;
</script>
{% endblock %}