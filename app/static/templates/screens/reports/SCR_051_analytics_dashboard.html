{% extends "base.html" %}
{% block title %}Reports & Analytics - CALIM 360{% endblock %}

{% block head %}
<style>
    :root {
        --primary: #2762cb;
        --primary-light: #e8f0fe;
        --success: #10b981;
        --success-light: #d1fae5;
        --warning: #f59e0b;
        --warning-light: #fef3c7;
        --danger: #ef4444;
        --danger-light: #fee2e2;
        --info: #3b82f6;
        --info-light: #dbeafe;
        --purple: #8b5cf6;
        --purple-light: #ede9fe;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-500: #6b7280;
        --gray-700: #374151;
        --gray-900: #111827;
        --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
        --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        --radius: 8px;
        --radius-lg: 12px;
    }

    .analytics-container {
        padding: 1.5rem;
        background: var(--gray-50);
        min-height: calc(100vh - 60px);
    }

    /* Header */
    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .analytics-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--gray-900);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .analytics-title i {
        color: var(--primary);
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border-radius: var(--radius);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: #1e4fa8;
    }

    .btn-outline {
        background: white;
        border: 1px solid var(--gray-300);
        color: var(--gray-700);
    }

    .btn-outline:hover {
        background: var(--gray-50);
        border-color: var(--primary);
        color: var(--primary);
    }

    /* Summary Cards */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .summary-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        box-shadow: var(--shadow);
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .summary-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .summary-icon.primary { background: var(--primary-light); color: var(--primary); }
    .summary-icon.success { background: var(--success-light); color: var(--success); }
    .summary-icon.warning { background: var(--warning-light); color: var(--warning); }
    .summary-icon.danger { background: var(--danger-light); color: var(--danger); }
    .summary-icon.info { background: var(--info-light); color: var(--info); }
    .summary-icon.purple { background: var(--purple-light); color: var(--purple); }

    .summary-content h3 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--gray-900);
        line-height: 1.2;
    }

    .summary-content p {
        font-size: 0.8125rem;
        color: var(--gray-500);
        margin-top: 0.25rem;
    }

    .summary-trend {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        margin-top: 0.5rem;
    }

    .trend-up { color: var(--success); }
    .trend-down { color: var(--danger); }

    /* Category Tabs */
    .category-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        background: white;
        padding: 0.5rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
    }

    .category-tab {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        border-radius: var(--radius);
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-500);
        background: transparent;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .category-tab:hover {
        background: var(--gray-100);
        color: var(--gray-700);
    }

    .category-tab.active {
        background: var(--primary);
        color: white;
    }

    .category-tab i {
        font-size: 1.125rem;
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 1.25rem;
    }

    .dashboard-card {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .dashboard-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .dashboard-card.full-width {
        grid-column: 1 / -1;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--gray-100);
        background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--gray-900);
    }

    .card-title i {
        font-size: 1.125rem;
        color: var(--primary);
    }

    .card-actions {
        display: flex;
        gap: 0.5rem;
    }

    .card-action-btn {
        width: 32px;
        height: 32px;
        border-radius: var(--radius);
        border: 1px solid var(--gray-200);
        background: white;
        color: var(--gray-500);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .card-action-btn:hover {
        background: var(--primary-light);
        border-color: var(--primary);
        color: var(--primary);
    }

    .card-body {
        padding: 1.25rem;
    }

    /* Chart Container */
    .chart-container {
        position: relative;
        height: 250px;
        width: 100%;
    }

    .chart-container.small {
        height: 180px;
    }

    .chart-container.large {
        height: 350px;
    }

    /* Stats Grid in Cards */
    .mini-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .mini-stat {
        text-align: center;
        padding: 0.75rem;
        background: var(--gray-50);
        border-radius: var(--radius);
    }

    .mini-stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-900);
    }

    .mini-stat-value.danger { color: var(--danger); }
    .mini-stat-value.warning { color: var(--warning); }
    .mini-stat-value.success { color: var(--success); }
    .mini-stat-value.primary { color: var(--primary); }

    .mini-stat-label {
        font-size: 0.6875rem;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 0.25rem;
    }

    /* Progress Bars */
    .progress-item {
        margin-bottom: 0.75rem;
    }

    .progress-item:last-child {
        margin-bottom: 0;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.375rem;
    }

    .progress-label {
        font-size: 0.8125rem;
        color: var(--gray-700);
    }

    .progress-value {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--gray-900);
    }

    .progress-bar {
        height: 8px;
        background: var(--gray-200);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .progress-fill.primary { background: var(--primary); }
    .progress-fill.success { background: var(--success); }
    .progress-fill.warning { background: var(--warning); }
    .progress-fill.danger { background: var(--danger); }

    /* Data Table */
    .data-table-container {
        max-height: 300px;
        overflow-y: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8125rem;
    }

    .data-table th {
        text-align: left;
        padding: 0.625rem 0.75rem;
        background: var(--gray-50);
        color: var(--gray-500);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.6875rem;
        letter-spacing: 0.05em;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .data-table td {
        padding: 0.625rem 0.75rem;
        border-bottom: 1px solid var(--gray-100);
        color: var(--gray-700);
    }

    .data-table tbody tr:hover {
        background: var(--gray-50);
    }

    /* Badges */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.625rem;
        border-radius: 9999px;
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-success { background: var(--success-light); color: var(--success); }
    .badge-warning { background: var(--warning-light); color: var(--warning); }
    .badge-danger { background: var(--danger-light); color: var(--danger); }
    .badge-info { background: var(--info-light); color: var(--info); }
    .badge-primary { background: var(--primary-light); color: var(--primary); }
    .badge-purple { background: var(--purple-light); color: var(--purple); }

    /* Activity Feed */
    .activity-feed {
        max-height: 320px;
        overflow-y: auto;
    }

    .activity-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--gray-100);
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 0.875rem;
    }

    .activity-icon.create { background: var(--success-light); color: var(--success); }
    .activity-icon.update { background: var(--info-light); color: var(--info); }
    .activity-icon.approve { background: var(--primary-light); color: var(--primary); }
    .activity-icon.delete { background: var(--danger-light); color: var(--danger); }

    .activity-content {
        flex: 1;
        min-width: 0;
    }

    .activity-text {
        font-size: 0.8125rem;
        color: var(--gray-700);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .activity-text strong {
        color: var(--gray-900);
    }

    .activity-meta {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.25rem;
        font-size: 0.6875rem;
        color: var(--gray-500);
    }

    /* Heatmap Grid */
    .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 0.5rem;
    }

    .heatmap-cell {
        aspect-ratio: 1;
        border-radius: var(--radius);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.6875rem;
        font-weight: 600;
        transition: transform 0.2s;
    }

    .heatmap-cell:hover {
        transform: scale(1.1);
    }

    .heatmap-cell.low { background: #dcfce7; color: #166534; }
    .heatmap-cell.medium { background: #fef9c3; color: #854d0e; }
    .heatmap-cell.high { background: #fee2e2; color: #991b1b; }

    /* Gauge */
    .gauge-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem 0;
    }

    .gauge {
        position: relative;
        width: 160px;
        height: 80px;
    }

    .gauge-value {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
    }

    .gauge-label {
        text-align: center;
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 0.5rem;
    }

    /* Loading Skeleton */
    .skeleton {
        background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
        border-radius: var(--radius);
    }

    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .analytics-container {
            padding: 1rem;
        }

        .dashboard-grid {
            grid-template-columns: 1fr;
        }

        .category-tabs {
            overflow-x: auto;
            flex-wrap: nowrap;
        }

        .mini-stats {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Hide inactive category content */
    .category-content {
        display: none;
    }

    .category-content.active {
        display: block;
    }

    /* Risk Level Colors */
    .risk-high { color: var(--danger); }
    .risk-medium { color: var(--warning); }
    .risk-low { color: var(--success); }

    /* Posture Colors */
    .posture-cooperative { color: var(--success); }
    .posture-neutral { color: var(--info); }
    .posture-adversarial { color: var(--danger); }

    /* Timeline View */
    .timeline-container {
        position: relative;
        padding-left: 1.5rem;
    }

    .timeline-container::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--gray-200);
    }

    .timeline-item {
        position: relative;
        padding-bottom: 1rem;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.25rem;
        top: 0.5rem;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--primary);
        border: 2px solid white;
        box-shadow: var(--shadow-sm);
    }

    .timeline-item.overdue::before { background: var(--danger); }
    .timeline-item.due-soon::before { background: var(--warning); }
    .timeline-item.on-track::before { background: var(--success); }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--gray-500);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h4 {
        font-size: 1rem;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        font-size: 0.875rem;
    }

    /* Blockchain Hash */
    .blockchain-hash {
        font-family: monospace;
        font-size: 0.6875rem;
        color: var(--gray-500);
        background: var(--gray-100);
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
    }

    /* Export Options */
    .export-dropdown {
        position: relative;
    }

    .export-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        padding: 0.5rem 0;
        min-width: 150px;
        z-index: 100;
        display: none;
    }

    .export-menu.show {
        display: block;
    }

    .export-menu a {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        color: var(--gray-700);
        text-decoration: none;
        font-size: 0.8125rem;
    }

    .export-menu a:hover {
        background: var(--gray-50);
    }

    /* Score Circle */
    .score-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }

    .score-circle.excellent { background: var(--success-light); border: 3px solid var(--success); }
    .score-circle.good { background: var(--info-light); border: 3px solid var(--info); }
    .score-circle.fair { background: var(--warning-light); border: 3px solid var(--warning); }
    .score-circle.poor { background: var(--danger-light); border: 3px solid var(--danger); }

    .score-circle .score-value {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .score-circle .score-label {
        font-size: 0.625rem;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Header -->
    <div class="analytics-header">
        <h1 class="analytics-title">
            <i class="ti ti-chart-dots-3"></i>
            Reports & Analytics
        </h1>
        <div class="header-actions">
            <button class="btn btn-outline" onclick="refreshAllDashboards()">
                <i class="ti ti-refresh"></i> Refresh
            </button>
            <div class="export-dropdown">
                <button class="btn btn-outline" onclick="toggleExportMenu()">
                    <i class="ti ti-download"></i> Export
                </button>
                <div class="export-menu" id="exportMenu">
                    <a href="#" onclick="exportReport('pdf')"><i class="ti ti-file-type-pdf"></i> Export PDF</a>
                    <a href="#" onclick="exportReport('excel')"><i class="ti ti-file-spreadsheet"></i> Export Excel</a>
                    <a href="#" onclick="exportReport('csv')"><i class="ti ti-file-type-csv"></i> Export CSV</a>
                </div>
            </div>
            <button class="btn btn-primary" onclick="window.location.href='/audit-trail'">
                <i class="ti ti-history"></i> Audit Trail
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-grid" id="summaryCards">
        <div class="summary-card">
            <div class="summary-icon primary">
                <i class="ti ti-file-text"></i>
            </div>
            <div class="summary-content">
                <h3 id="totalContracts">--</h3>
                <p>Total Contracts</p>
                <div class="summary-trend trend-up">
                    <i class="ti ti-trending-up"></i>
                    <span id="contractsTrend">Loading...</span>
                </div>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon success">
                <i class="ti ti-circle-check"></i>
            </div>
            <div class="summary-content">
                <h3 id="activeContracts">--</h3>
                <p>Active Contracts</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon warning">
                <i class="ti ti-alert-triangle"></i>
            </div>
            <div class="summary-content">
                <h3 id="obligationsOverdue">--</h3>
                <p>Overdue Obligations</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon danger">
                <i class="ti ti-flame"></i>
            </div>
            <div class="summary-content">
                <h3 id="highRiskContracts">--</h3>
                <p>High Risk Contracts</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon info">
                <i class="ti ti-activity"></i>
            </div>
            <div class="summary-content">
                <h3 id="recentActivity">--</h3>
                <p>Actions (7 Days)</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon purple">
                <i class="ti ti-currency-dollar"></i>
            </div>
            <div class="summary-content">
                <h3 id="totalValue">--</h3>
                <p>Total Portfolio Value</p>
            </div>
        </div>
    </div>

    <!-- Category Tabs -->
    <div class="category-tabs">
        <button class="category-tab active" data-category="creation" onclick="switchCategory('creation')">
            <i class="ti ti-file-plus"></i>
            Contract Creation
        </button>
        <button class="category-tab" data-category="execution" onclick="switchCategory('execution')">
            <i class="ti ti-send"></i>
            Execution & Communication
        </button>
        <button class="category-tab" data-category="governance" onclick="switchCategory('governance')">
            <i class="ti ti-shield-check"></i>
            Governance & Integrity
        </button>
        <button class="category-tab" data-category="intelligence" onclick="switchCategory('intelligence')">
            <i class="ti ti-brain"></i>
            Contract Intelligence
        </button>
    </div>

    <!-- Category 1: Contract Creation Intelligence -->
    <div class="category-content active" id="category-creation">
        <div class="dashboard-grid">
            <!-- Clause Risk Heatmap -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-flame"></i>
                        Clause Risk Heatmap
                    </div>
                    <div class="card-actions">
                        <button class="card-action-btn" title="Refresh"><i class="ti ti-refresh"></i></button>
                        <button class="card-action-btn" title="Expand"><i class="ti ti-arrows-maximize"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value danger" id="highRiskClauses">--</div>
                            <div class="mini-stat-label">High Risk</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value warning" id="mediumRiskClauses">--</div>
                            <div class="mini-stat-label">Medium Risk</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value success" id="lowRiskClauses">--</div>
                            <div class="mini-stat-label">Low Risk</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="clauseRiskChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Review Cycle Velocity -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-gauge"></i>
                        Review Cycle Velocity
                    </div>
                    <div class="card-actions">
                        <button class="card-action-btn" title="Refresh"><i class="ti ti-refresh"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value primary" id="avgReviewDays">--</div>
                            <div class="mini-stat-label">Avg Days</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value" id="inReviewCount">--</div>
                            <div class="mini-stat-label">In Review</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value danger" id="bottlenecksCount">--</div>
                            <div class="mini-stat-label">Bottlenecks</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="velocityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Negotiation Posture Index -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-mood-happy"></i>
                        Negotiation Posture Index
                    </div>
                    <div class="card-actions">
                        <button class="card-action-btn" title="Refresh"><i class="ti ti-refresh"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value success" id="cooperativeCount">--</div>
                            <div class="mini-stat-label">Cooperative</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value primary" id="neutralCount">--</div>
                            <div class="mini-stat-label">Neutral</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value danger" id="adversarialCount">--</div>
                            <div class="mini-stat-label">Adversarial</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="postureChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Change Impact Preview -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-git-compare"></i>
                        Change Impact Preview
                    </div>
                    <div class="card-actions">
                        <button class="card-action-btn" title="Refresh"><i class="ti ti-refresh"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="data-table-container" id="changeImpactTable">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Stakeholder Engagement -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-users"></i>
                        Stakeholder Engagement Pulse
                    </div>
                    <div class="card-actions">
                        <button class="card-action-btn" title="Refresh"><i class="ti ti-refresh"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value success" id="activeUsers">--</div>
                            <div class="mini-stat-label">Active</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value warning" id="inactiveUsers">--</div>
                            <div class="mini-stat-label">Inactive</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value primary" id="engagementRate">--</div>
                            <div class="mini-stat-label">Engagement %</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="engagementChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Draft Quality Score -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-star"></i>
                        Draft Quality Score
                    </div>
                    <div class="card-actions">
                        <button class="card-action-btn" title="Refresh"><i class="ti ti-refresh"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="gauge-container">
                        <div class="score-circle excellent" id="qualityScoreCircle">
                            <span class="score-value" id="avgQualityScore">--</span>
                            <span class="score-label">Score</span>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Clarity</span>
                                <span class="progress-value" id="clarityScore">--</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill primary" id="clarityBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Completeness</span>
                                <span class="progress-value" id="completenessScore">--</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill success" id="completenessBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Risk Alignment</span>
                                <span class="progress-value" id="riskAlignmentScore">--</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill warning" id="riskAlignmentBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category 2: Execution & Communication -->
    <div class="category-content" id="category-execution">
        <div class="dashboard-grid">
            <!-- Signature Readiness -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-writing-sign"></i>
                        Signature Readiness Tracker
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value success" id="sigReady">--</div>
                            <div class="mini-stat-label">Ready</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value warning" id="sigPending">--</div>
                            <div class="mini-stat-label">Pending</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value danger" id="sigHesitant">--</div>
                            <div class="mini-stat-label">Hesitant</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="signatureChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Communication Sentiment -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-mood-search"></i>
                        Communication Sentiment
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value success" id="sentimentPositive">--</div>
                            <div class="mini-stat-label">Positive</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value primary" id="sentimentNeutral">--</div>
                            <div class="mini-stat-label">Neutral</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value danger" id="sentimentNegative">--</div>
                            <div class="mini-stat-label">Negative</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SLA Response Compliance -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-clock-check"></i>
                        SLA Response Compliance
                    </div>
                </div>
                <div class="card-body">
                    <div class="gauge-container">
                        <div class="score-circle excellent" id="slaScoreCircle">
                            <span class="score-value" id="slaComplianceRate">--</span>
                            <span class="score-label">Compliant</span>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Within SLA</span>
                                <span class="progress-value success" id="slaCompliant">--</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill success" id="slaCompliantBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Breached SLA</span>
                                <span class="progress-value danger" id="slaNonCompliant">--</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill danger" id="slaNonCompliantBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Communication Priority Radar -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-radar"></i>
                        Communication Priority Radar
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value danger" id="priorityCritical">--</div>
                            <div class="mini-stat-label">Critical</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value warning" id="priorityHigh">--</div>
                            <div class="mini-stat-label">High</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value primary" id="priorityNormal">--</div>
                            <div class="mini-stat-label">Normal</div>
                        </div>
                    </div>
                    <div class="data-table-container" id="priorityTable">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Correspondence-Obligation Link -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-link"></i>
                        Correspondence-Obligation Map
                    </div>
                </div>
                <div class="card-body">
                    <div class="data-table-container" id="obligationLinkTable">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Approval Lag Predictor -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-clock-pause"></i>
                        Approval Lag Predictor
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value" id="totalPendingApprovals">--</div>
                            <div class="mini-stat-label">Pending</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value warning" id="avgPendingDays">--</div>
                            <div class="mini-stat-label">Avg Days</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value danger" id="atRiskApprovals">--</div>
                            <div class="mini-stat-label">At Risk</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="approvalLagChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category 3: Governance & Integrity -->
    <div class="category-content" id="category-governance">
        <div class="dashboard-grid">
            <!-- Immutable Activity Feed -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-blockchain"></i>
                        Immutable Activity Feed
                    </div>
                    <div class="card-actions">
                        <span class="badge badge-success">
                            <i class="ti ti-check"></i> Blockchain Verified
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="activity-feed" id="activityFeed">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Compliance Drift Detector -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-compass"></i>
                        Compliance Drift Detector
                    </div>
                </div>
                <div class="card-body">
                    <div class="gauge-container">
                        <div class="score-circle excellent" id="complianceScoreCircle">
                            <span class="score-value" id="complianceRate">--</span>
                            <span class="score-label">Compliant</span>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;" id="complianceDriftList">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Audit Event Analyzer -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-chart-bar"></i>
                        Audit Event Analyzer
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value" id="totalAuditEvents">--</div>
                            <div class="mini-stat-label">Total Events</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value primary" id="avgDailyEvents">--</div>
                            <div class="mini-stat-label">Avg/Day</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value danger" id="suspiciousChanges">--</div>
                            <div class="mini-stat-label">Anomalies</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="auditEventChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Regulatory Readiness -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-gavel"></i>
                        Regulatory Readiness
                    </div>
                </div>
                <div class="card-body">
                    <div id="regulatoryChecks">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Access Integrity Monitor -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-eye"></i>
                        Access Integrity Monitor
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value" id="totalAccesses">--</div>
                            <div class="mini-stat-label">Accesses</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value primary" id="uniqueUsers">--</div>
                            <div class="mini-stat-label">Users</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value warning" id="unusualPatterns">--</div>
                            <div class="mini-stat-label">Unusual</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="accessChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Contract Security Index -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-shield-lock"></i>
                        Contract Security Index
                    </div>
                </div>
                <div class="card-body">
                    <div class="gauge-container">
                        <div class="score-circle excellent" id="securityScoreCircle">
                            <span class="score-value" id="avgSecurityScore">--</span>
                            <span class="score-label">Score</span>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">High Security</span>
                                <span class="progress-value success" id="highSecurityCount">--</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill success" id="highSecurityBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Medium Security</span>
                                <span class="progress-value warning" id="mediumSecurityCount">--</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill warning" id="mediumSecurityBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Low Security</span>
                                <span class="progress-value danger" id="lowSecurityCount">--</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill danger" id="lowSecurityBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category 4: Contract Intelligence -->
    <div class="category-content" id="category-intelligence">
        <div class="dashboard-grid">
            <!-- Contract Risk Prediction -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-alert-octagon"></i>
                        Risk Prediction Panel
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value danger" id="riskHigh">--</div>
                            <div class="mini-stat-label">High Risk</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value warning" id="riskMedium">--</div>
                            <div class="mini-stat-label">Medium Risk</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value success" id="riskLow">--</div>
                            <div class="mini-stat-label">Low Risk</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="riskPredictionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Obligation Exposure Meter -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-meter"></i>
                        Obligation Exposure Meter
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value danger" id="obligationsOverdueInt">--</div>
                            <div class="mini-stat-label">Overdue</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value warning" id="obligationsThisWeek">--</div>
                            <div class="mini-stat-label">This Week</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value primary" id="obligationsThisMonth">--</div>
                            <div class="mini-stat-label">This Month</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="exposureChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Cost Leakage Tracker -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-currency-dollar-off"></i>
                        Cost Leakage Tracker
                    </div>
                </div>
                <div class="card-body">
                    <div class="gauge-container">
                        <div class="score-circle fair" id="leakageScoreCircle">
                            <span class="score-value" id="totalLeakage">--</span>
                            <span class="score-label">Leakage</span>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;" id="leakageCategories">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Timeline Deviation Forecast -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-calendar-exclamation"></i>
                        Timeline Deviation Forecast
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value success" id="timelineOnTrack">--</div>
                            <div class="mini-stat-label">On Track</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value warning" id="timelineAtRisk">--</div>
                            <div class="mini-stat-label">At Risk</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value danger" id="timelineDelayed">--</div>
                            <div class="mini-stat-label">Delayed</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- What If Scenario Simulation -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-arrow-fork"></i>
                        Scenario Simulation
                    </div>
                </div>
                <div class="card-body">
                    <div id="scenarioList">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Relationship Health -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="ti ti-heart-handshake"></i>
                        Relationship Health
                    </div>
                </div>
                <div class="card-body">
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-value success" id="healthExcellent">--</div>
                            <div class="mini-stat-label">Excellent</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value primary" id="healthGood">--</div>
                            <div class="mini-stat-label">Good</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value warning" id="healthFair">--</div>
                            <div class="mini-stat-label">Fair</div>
                        </div>
                    </div>
                    <div class="chart-container small">
                        <canvas id="relationshipChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let charts = {};
let currentCategory = 'creation';

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSummaryData();
    loadCreationDashboards();
});

// Category switching
function switchCategory(category) {
    currentCategory = category;
    
    // Update tabs
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.category === category);
    });
    
    // Update content
    document.querySelectorAll('.category-content').forEach(content => {
        content.classList.toggle('active', content.id === `category-${category}`);
    });
    
    // Load data for the category
    switch(category) {
        case 'creation':
            loadCreationDashboards();
            break;
        case 'execution':
            loadExecutionDashboards();
            break;
        case 'governance':
            loadGovernanceDashboards();
            break;
        case 'intelligence':
            loadIntelligenceDashboards();
            break;
    }
}

// Load summary data
async function loadSummaryData() {
    try {
        const response = await fetch('/api/reports/analytics/summary');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('totalContracts').textContent = data.contracts.total;
            document.getElementById('activeContracts').textContent = data.contracts.active;
            document.getElementById('obligationsOverdue').textContent = data.obligations.overdue;
            document.getElementById('highRiskContracts').textContent = data.contracts.high_value;
            document.getElementById('recentActivity').textContent = data.activity.last_7_days;
            document.getElementById('totalValue').textContent = formatCurrency(data.contracts.total_value);
            document.getElementById('contractsTrend').textContent = `${data.contracts.in_progress} in progress`;
        }
    } catch (error) {
        console.error('Error loading summary:', error);
    }
}

// Format currency
function formatCurrency(value) {
    if (value >= 1000000) {
        return 'QAR ' + (value / 1000000).toFixed(1) + 'M';
    } else if (value >= 1000) {
        return 'QAR ' + (value / 1000).toFixed(1) + 'K';
    }
    return 'QAR ' + value.toFixed(0);
}

// =====================================================
// CATEGORY 1: CONTRACT CREATION INTELLIGENCE
// =====================================================

async function loadCreationDashboards() {
    await Promise.all([
        loadClauseRiskHeatmap(),
        loadReviewVelocity(),
        loadNegotiationPosture(),
        loadChangeImpact(),
        loadStakeholderEngagement(),
        loadDraftQuality()
    ]);
}

async function loadClauseRiskHeatmap() {
    try {
        const response = await fetch('/api/reports/analytics/clause-risk-heatmap');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('highRiskClauses').textContent = data.risk_distribution.high;
            document.getElementById('mediumRiskClauses').textContent = data.risk_distribution.medium;
            document.getElementById('lowRiskClauses').textContent = data.risk_distribution.low;
            
            // Create chart
            createOrUpdateChart('clauseRiskChart', 'doughnut', {
                labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                datasets: [{
                    data: [data.risk_distribution.high, data.risk_distribution.medium, data.risk_distribution.low],
                    backgroundColor: ['#ef4444', '#f59e0b', '#10b981']
                }]
            });
        }
    } catch (error) {
        console.error('Error loading clause risk:', error);
    }
}

async function loadReviewVelocity() {
    try {
        const response = await fetch('/api/reports/analytics/review-cycle-velocity');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('avgReviewDays').textContent = data.avg_review_days.toFixed(1);
            document.getElementById('inReviewCount').textContent = data.contracts_in_review;
            document.getElementById('bottlenecksCount').textContent = data.bottlenecks_count;
            
            // Create trend chart
            const labels = data.velocity_trend.map(v => v.month);
            const values = data.velocity_trend.map(v => v.avg_days);
            
            createOrUpdateChart('velocityChart', 'line', {
                labels: labels,
                datasets: [{
                    label: 'Avg Review Days',
                    data: values,
                    borderColor: '#2762cb',
                    backgroundColor: 'rgba(39, 98, 203, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            });
        }
    } catch (error) {
        console.error('Error loading review velocity:', error);
    }
}

async function loadNegotiationPosture() {
    try {
        const response = await fetch('/api/reports/analytics/negotiation-posture');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('cooperativeCount').textContent = data.posture_distribution.cooperative;
            document.getElementById('neutralCount').textContent = data.posture_distribution.neutral;
            document.getElementById('adversarialCount').textContent = data.posture_distribution.adversarial;
            
            createOrUpdateChart('postureChart', 'doughnut', {
                labels: ['Cooperative', 'Neutral', 'Adversarial'],
                datasets: [{
                    data: [
                        data.posture_distribution.cooperative,
                        data.posture_distribution.neutral,
                        data.posture_distribution.adversarial
                    ],
                    backgroundColor: ['#10b981', '#3b82f6', '#ef4444']
                }]
            });
        }
    } catch (error) {
        console.error('Error loading negotiation posture:', error);
    }
}

async function loadChangeImpact() {
    try {
        const response = await fetch('/api/reports/analytics/change-impact-preview');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Contract</th>
                        <th>Change Type</th>
                        <th>Category</th>
                        <th>Impact</th>
                    </tr>
                </thead>
                <tbody>`;
            
            data.recent_changes.slice(0, 8).forEach(change => {
                html += `<tr>
                    <td><strong>${change.contract_number || 'N/A'}</strong></td>
                    <td>${change.change_type}</td>
                    <td>${change.category}</td>
                    <td><span class="badge badge-${change.impact_level === 'high' ? 'danger' : 'warning'}">${change.impact_level}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('changeImpactTable').innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading change impact:', error);
    }
}

async function loadStakeholderEngagement() {
    try {
        const response = await fetch('/api/reports/analytics/stakeholder-engagement');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('activeUsers').textContent = data.active_users;
            document.getElementById('inactiveUsers').textContent = data.inactive_users;
            document.getElementById('engagementRate').textContent = data.engagement_rate + '%';
            
            // Create horizontal bar chart
            const topUsers = data.stakeholders.slice(0, 5);
            createOrUpdateChart('engagementChart', 'bar', {
                labels: topUsers.map(u => u.name.split(' ')[0]),
                datasets: [{
                    label: 'Actions',
                    data: topUsers.map(u => u.recent_actions),
                    backgroundColor: '#2762cb'
                }]
            }, { indexAxis: 'y' });
        }
    } catch (error) {
        console.error('Error loading stakeholder engagement:', error);
    }
}

async function loadDraftQuality() {
    try {
        const response = await fetch('/api/reports/analytics/draft-quality-score');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            const avgScore = data.average_score;
            
            document.getElementById('avgQualityScore').textContent = avgScore.toFixed(0);
            updateScoreCircle('qualityScoreCircle', avgScore);
            
            // Get first draft scores for display
            if (data.drafts.length > 0) {
                const firstDraft = data.drafts[0];
                document.getElementById('clarityScore').textContent = firstDraft.scores.clarity.toFixed(0) + '%';
                document.getElementById('clarityBar').style.width = firstDraft.scores.clarity + '%';
                document.getElementById('completenessScore').textContent = firstDraft.scores.completeness.toFixed(0) + '%';
                document.getElementById('completenessBar').style.width = firstDraft.scores.completeness + '%';
                document.getElementById('riskAlignmentScore').textContent = firstDraft.scores.risk_alignment.toFixed(0) + '%';
                document.getElementById('riskAlignmentBar').style.width = firstDraft.scores.risk_alignment + '%';
            }
        }
    } catch (error) {
        console.error('Error loading draft quality:', error);
    }
}

// =====================================================
// CATEGORY 2: EXECUTION & COMMUNICATION
// =====================================================

async function loadExecutionDashboards() {
    await Promise.all([
        loadSignatureReadiness(),
        loadCommunicationSentiment(),
        loadSLACompliance(),
        loadCommunicationPriority(),
        loadObligationLinks(),
        loadApprovalLag()
    ]);
}

async function loadSignatureReadiness() {
    try {
        const response = await fetch('/api/reports/analytics/signature-readiness');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('sigReady').textContent = data.readiness_distribution.ready;
            document.getElementById('sigPending').textContent = data.readiness_distribution.pending;
            document.getElementById('sigHesitant').textContent = data.readiness_distribution.hesitant;
            
            createOrUpdateChart('signatureChart', 'doughnut', {
                labels: ['Ready', 'Pending', 'Hesitant'],
                datasets: [{
                    data: [
                        data.readiness_distribution.ready,
                        data.readiness_distribution.pending,
                        data.readiness_distribution.hesitant
                    ],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                }]
            });
        }
    } catch (error) {
        console.error('Error loading signature readiness:', error);
    }
}

async function loadCommunicationSentiment() {
    try {
        const response = await fetch('/api/reports/analytics/communication-sentiment');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('sentimentPositive').textContent = data.sentiment_distribution.positive;
            document.getElementById('sentimentNeutral').textContent = data.sentiment_distribution.neutral;
            document.getElementById('sentimentNegative').textContent = data.sentiment_distribution.negative;
            
            createOrUpdateChart('sentimentChart', 'doughnut', {
                labels: ['Positive', 'Neutral', 'Negative'],
                datasets: [{
                    data: [
                        data.sentiment_distribution.positive,
                        data.sentiment_distribution.neutral,
                        data.sentiment_distribution.negative
                    ],
                    backgroundColor: ['#10b981', '#3b82f6', '#ef4444']
                }]
            });
        }
    } catch (error) {
        console.error('Error loading communication sentiment:', error);
    }
}

async function loadSLACompliance() {
    try {
        const response = await fetch('/api/reports/analytics/sla-response-compliance');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('slaComplianceRate').textContent = data.compliance_rate.toFixed(0) + '%';
            updateScoreCircle('slaScoreCircle', data.compliance_rate);
            
            const total = data.compliant_count + data.non_compliant_count;
            const compliantPct = total > 0 ? (data.compliant_count / total * 100) : 0;
            const nonCompliantPct = total > 0 ? (data.non_compliant_count / total * 100) : 0;
            
            document.getElementById('slaCompliant').textContent = data.compliant_count;
            document.getElementById('slaCompliantBar').style.width = compliantPct + '%';
            document.getElementById('slaNonCompliant').textContent = data.non_compliant_count;
            document.getElementById('slaNonCompliantBar').style.width = nonCompliantPct + '%';
        }
    } catch (error) {
        console.error('Error loading SLA compliance:', error);
    }
}

async function loadCommunicationPriority() {
    try {
        const response = await fetch('/api/reports/analytics/communication-priority');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('priorityCritical').textContent = data.priority_distribution.critical || 0;
            document.getElementById('priorityHigh').textContent = data.priority_distribution.high || 0;
            document.getElementById('priorityNormal').textContent = data.priority_distribution.normal || 0;
            
            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Priority</th>
                        <th>Title</th>
                        <th>Contract</th>
                    </tr>
                </thead>
                <tbody>`;
            
            data.priority_items.slice(0, 6).forEach(item => {
                const badgeClass = item.priority === 'critical' ? 'danger' : item.priority === 'high' ? 'warning' : 'info';
                html += `<tr>
                    <td><span class="badge badge-${badgeClass}">${item.priority}</span></td>
                    <td>${item.title || 'Notification'}</td>
                    <td>${item.contract_number || 'N/A'}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('priorityTable').innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading communication priority:', error);
    }
}

async function loadObligationLinks() {
    try {
        const response = await fetch('/api/reports/analytics/correspondence-obligation-link');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            
            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Obligation</th>
                        <th>Contract</th>
                        <th>Docs</th>
                        <th>Risk</th>
                    </tr>
                </thead>
                <tbody>`;
            
            data.obligation_links.slice(0, 6).forEach(link => {
                const badgeClass = link.risk_severity === 'high' ? 'danger' : 'warning';
                html += `<tr>
                    <td>${link.obligation_title.substring(0, 25)}...</td>
                    <td>${link.contract_number || 'N/A'}</td>
                    <td>${link.linked_documents}</td>
                    <td><span class="badge badge-${badgeClass}">${link.risk_severity}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('obligationLinkTable').innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading obligation links:', error);
    }
}

async function loadApprovalLag() {
    try {
        const response = await fetch('/api/reports/analytics/approval-lag-predictor');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('totalPendingApprovals').textContent = data.total_pending;
            document.getElementById('avgPendingDays').textContent = data.avg_days_pending.toFixed(1);
            document.getElementById('atRiskApprovals').textContent = data.at_risk_approvals;
            
            // Create bar chart of pending approvals by days
            const pendingByDays = {};
            data.pending_approvals.forEach(p => {
                const bucket = p.days_pending <= 3 ? '0-3 days' : 
                               p.days_pending <= 7 ? '4-7 days' : '7+ days';
                pendingByDays[bucket] = (pendingByDays[bucket] || 0) + 1;
            });
            
            createOrUpdateChart('approvalLagChart', 'bar', {
                labels: Object.keys(pendingByDays),
                datasets: [{
                    label: 'Pending Approvals',
                    data: Object.values(pendingByDays),
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                }]
            });
        }
    } catch (error) {
        console.error('Error loading approval lag:', error);
    }
}

// =====================================================
// CATEGORY 3: GOVERNANCE & INTEGRITY
// =====================================================

async function loadGovernanceDashboards() {
    await Promise.all([
        loadActivityFeed(),
        loadComplianceDrift(),
        loadAuditAnalyzer(),
        loadRegulatoryReadiness(),
        loadAccessIntegrity(),
        loadSecurityIndex()
    ]);
}

async function loadActivityFeed() {
    try {
        const response = await fetch('/api/reports/analytics/immutable-activity-feed');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            let html = '';
            
            data.activities.slice(0, 15).forEach(activity => {
                const iconClass = activity.action_type.includes('create') ? 'create' :
                                  activity.action_type.includes('approve') ? 'approve' :
                                  activity.action_type.includes('delete') ? 'delete' : 'update';
                const icon = iconClass === 'create' ? 'ti-plus' :
                            iconClass === 'approve' ? 'ti-check' :
                            iconClass === 'delete' ? 'ti-trash' : 'ti-pencil';
                
                html += `<div class="activity-item">
                    <div class="activity-icon ${iconClass}">
                        <i class="ti ${icon}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-text">
                            <strong>${activity.user}</strong> ${activity.action_type}
                            ${activity.contract_number ? `on <strong>${activity.contract_number}</strong>` : ''}
                        </div>
                        <div class="activity-meta">
                            <span><i class="ti ti-clock"></i> ${formatDateTime(activity.timestamp)}</span>
                            <span class="blockchain-hash">${activity.hash}</span>
                        </div>
                    </div>
                </div>`;
            });
            
            document.getElementById('activityFeed').innerHTML = html || '<div class="empty-state"><p>No recent activity</p></div>';
        }
    } catch (error) {
        console.error('Error loading activity feed:', error);
    }
}

async function loadComplianceDrift() {
    try {
        const response = await fetch('/api/reports/analytics/compliance-drift');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('complianceRate').textContent = data.compliance_rate.toFixed(0) + '%';
            updateScoreCircle('complianceScoreCircle', data.compliance_rate);
            
            let html = '';
            const driftingContracts = data.contracts.filter(c => c.is_drifting).slice(0, 4);
            
            driftingContracts.forEach(contract => {
                html += `<div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">${contract.contract_number}</span>
                        <span class="progress-value danger">${contract.drift_indicators.length} issues</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill danger" style="width: ${100 - contract.compliance_score}%"></div>
                    </div>
                </div>`;
            });
            
            document.getElementById('complianceDriftList').innerHTML = html || '<p style="text-align:center; color: var(--gray-500);">No compliance drift detected</p>';
        }
    } catch (error) {
        console.error('Error loading compliance drift:', error);
    }
}

async function loadAuditAnalyzer() {
    try {
        const response = await fetch('/api/reports/analytics/audit-event-analyzer');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('totalAuditEvents').textContent = data.total_events;
            document.getElementById('avgDailyEvents').textContent = data.avg_daily_events.toFixed(0);
            document.getElementById('suspiciousChanges').textContent = data.anomalies.length;
            
            // Create line chart of events over time
            const dates = Object.keys(data.events_by_date).slice(-14);
            const values = dates.map(d => data.events_by_date[d]);
            
            createOrUpdateChart('auditEventChart', 'line', {
                labels: dates.map(d => d.substring(5)),
                datasets: [{
                    label: 'Events',
                    data: values,
                    borderColor: '#2762cb',
                    backgroundColor: 'rgba(39, 98, 203, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            });
        }
    } catch (error) {
        console.error('Error loading audit analyzer:', error);
    }
}

async function loadRegulatoryReadiness() {
    try {
        const response = await fetch('/api/reports/analytics/regulatory-readiness');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            let html = '';
            
            data.regulatory_checks.forEach(check => {
                const score = Math.min(100, data.average_score + (Math.random() * 10 - 5));
                const colorClass = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
                
                html += `<div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">${check.name}</span>
                        <span class="progress-value ${colorClass}">${score.toFixed(0)}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${colorClass}" style="width: ${score}%"></div>
                    </div>
                </div>`;
            });
            
            document.getElementById('regulatoryChecks').innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading regulatory readiness:', error);
    }
}

async function loadAccessIntegrity() {
    try {
        const response = await fetch('/api/reports/analytics/access-integrity');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('totalAccesses').textContent = data.total_accesses;
            document.getElementById('uniqueUsers').textContent = data.unique_users;
            document.getElementById('unusualPatterns').textContent = data.unusual_patterns.length;
            
            // Create pie chart of accesses by user
            const topUsers = Object.entries(data.access_by_user)
                .sort((a, b) => b[1].access_count - a[1].access_count)
                .slice(0, 5);
            
            createOrUpdateChart('accessChart', 'doughnut', {
                labels: topUsers.map(u => u[1].name || u[0].split('@')[0]),
                datasets: [{
                    data: topUsers.map(u => u[1].access_count),
                    backgroundColor: ['#2762cb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                }]
            });
        }
    } catch (error) {
        console.error('Error loading access integrity:', error);
    }
}

async function loadSecurityIndex() {
    try {
        const response = await fetch('/api/reports/analytics/contract-security-index');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('avgSecurityScore').textContent = data.average_security_score.toFixed(0);
            updateScoreCircle('securityScoreCircle', data.average_security_score);
            
            const total = data.high_security_count + data.medium_security_count + data.low_security_count;
            const highPct = total > 0 ? (data.high_security_count / total * 100) : 0;
            const medPct = total > 0 ? (data.medium_security_count / total * 100) : 0;
            const lowPct = total > 0 ? (data.low_security_count / total * 100) : 0;
            
            document.getElementById('highSecurityCount').textContent = data.high_security_count;
            document.getElementById('highSecurityBar').style.width = highPct + '%';
            document.getElementById('mediumSecurityCount').textContent = data.medium_security_count;
            document.getElementById('mediumSecurityBar').style.width = medPct + '%';
            document.getElementById('lowSecurityCount').textContent = data.low_security_count;
            document.getElementById('lowSecurityBar').style.width = lowPct + '%';
        }
    } catch (error) {
        console.error('Error loading security index:', error);
    }
}

// =====================================================
// CATEGORY 4: CONTRACT INTELLIGENCE
// =====================================================

async function loadIntelligenceDashboards() {
    await Promise.all([
        loadRiskPrediction(),
        loadObligationExposure(),
        loadCostLeakage(),
        loadTimelineDeviation(),
        loadScenarioSimulation(),
        loadRelationshipHealth()
    ]);
}

async function loadRiskPrediction() {
    try {
        const response = await fetch('/api/reports/analytics/risk-prediction');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('riskHigh').textContent = data.risk_distribution.high;
            document.getElementById('riskMedium').textContent = data.risk_distribution.medium;
            document.getElementById('riskLow').textContent = data.risk_distribution.low;
            
            createOrUpdateChart('riskPredictionChart', 'doughnut', {
                labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                datasets: [{
                    data: [
                        data.risk_distribution.high,
                        data.risk_distribution.medium,
                        data.risk_distribution.low
                    ],
                    backgroundColor: ['#ef4444', '#f59e0b', '#10b981']
                }]
            });
        }
    } catch (error) {
        console.error('Error loading risk prediction:', error);
    }
}

async function loadObligationExposure() {
    try {
        const response = await fetch('/api/reports/analytics/obligation-exposure');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('obligationsOverdueInt').textContent = data.exposure_by_timeline.overdue;
            document.getElementById('obligationsThisWeek').textContent = data.exposure_by_timeline.this_week;
            document.getElementById('obligationsThisMonth').textContent = data.exposure_by_timeline.this_month;
            
            createOrUpdateChart('exposureChart', 'bar', {
                labels: ['Overdue', 'This Week', 'This Month', 'Later'],
                datasets: [{
                    label: 'Obligations',
                    data: [
                        data.exposure_by_timeline.overdue,
                        data.exposure_by_timeline.this_week,
                        data.exposure_by_timeline.this_month,
                        data.exposure_by_timeline.later
                    ],
                    backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981']
                }]
            });
        }
    } catch (error) {
        console.error('Error loading obligation exposure:', error);
    }
}

async function loadCostLeakage() {
    try {
        const response = await fetch('/api/reports/analytics/cost-leakage');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('totalLeakage').textContent = formatCurrency(data.total_leakage).replace('QAR ', '');
            
            let html = '';
            Object.entries(data.leakage_categories).forEach(([category, count]) => {
                if (count > 0) {
                    html += `<div class="progress-item">
                        <div class="progress-header">
                            <span class="progress-label">${category.replace(/_/g, ' ')}</span>
                            <span class="progress-value warning">${count} contracts</span>
                        </div>
                    </div>`;
                }
            });
            
            document.getElementById('leakageCategories').innerHTML = html || '<p style="text-align:center; color: var(--gray-500);">No significant leakage detected</p>';
        }
    } catch (error) {
        console.error('Error loading cost leakage:', error);
    }
}

async function loadTimelineDeviation() {
    try {
        const response = await fetch('/api/reports/analytics/timeline-deviation');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('timelineOnTrack').textContent = data.deviation_counts.on_track;
            document.getElementById('timelineAtRisk').textContent = data.deviation_counts.at_risk;
            document.getElementById('timelineDelayed').textContent = data.deviation_counts.delayed;
            
            createOrUpdateChart('timelineChart', 'doughnut', {
                labels: ['On Track', 'At Risk', 'Delayed'],
                datasets: [{
                    data: [
                        data.deviation_counts.on_track,
                        data.deviation_counts.at_risk,
                        data.deviation_counts.delayed
                    ],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                }]
            });
        }
    } catch (error) {
        console.error('Error loading timeline deviation:', error);
    }
}

async function loadScenarioSimulation() {
    try {
        const response = await fetch('/api/reports/analytics/scenario-simulation');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            let html = '';
            
            data.scenarios.forEach((scenario, idx) => {
                const icons = ['ti-calendar-plus', 'ti-trending-up', 'ti-alert-triangle', 'ti-gavel'];
                const colors = ['primary', 'success', 'warning', 'info'];
                
                html += `<div style="padding: 0.75rem; background: var(--gray-50); border-radius: var(--radius); margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <i class="ti ${icons[idx % 4]}" style="color: var(--${colors[idx % 4]})"></i>
                        <strong style="font-size: 0.875rem;">${scenario.scenario_name}</strong>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--gray-500); margin: 0;">${scenario.description}</p>
                </div>`;
            });
            
            document.getElementById('scenarioList').innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading scenario simulation:', error);
    }
}

async function loadRelationshipHealth() {
    try {
        const response = await fetch('/api/reports/analytics/relationship-health');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('healthExcellent').textContent = data.health_distribution.excellent;
            document.getElementById('healthGood').textContent = data.health_distribution.good;
            document.getElementById('healthFair').textContent = data.health_distribution.fair;
            
            createOrUpdateChart('relationshipChart', 'doughnut', {
                labels: ['Excellent', 'Good', 'Fair', 'Poor'],
                datasets: [{
                    data: [
                        data.health_distribution.excellent,
                        data.health_distribution.good,
                        data.health_distribution.fair,
                        data.health_distribution.poor || 0
                    ],
                    backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444']
                }]
            });
        }
    } catch (error) {
        console.error('Error loading relationship health:', error);
    }
}

// =====================================================
// UTILITY FUNCTIONS
// =====================================================

function createOrUpdateChart(chartId, type, data, options = {}) {
    const ctx = document.getElementById(chartId);
    if (!ctx) return;
    
    // Destroy existing chart
    if (charts[chartId]) {
        charts[chartId].destroy();
    }
    
    const defaultOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: type === 'doughnut' || type === 'pie',
                position: 'bottom',
                labels: {
                    boxWidth: 12,
                    padding: 8,
                    font: { size: 10 }
                }
            }
        }
    };
    
    if (type === 'doughnut' || type === 'pie') {
        defaultOptions.cutout = '60%';
    }
    
    charts[chartId] = new Chart(ctx.getContext('2d'), {
        type: type,
        data: data,
        options: { ...defaultOptions, ...options }
    });
}

function updateScoreCircle(elementId, score) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    element.classList.remove('excellent', 'good', 'fair', 'poor');
    
    if (score >= 80) {
        element.classList.add('excellent');
    } else if (score >= 65) {
        element.classList.add('good');
    } else if (score >= 50) {
        element.classList.add('fair');
    } else {
        element.classList.add('poor');
    }
}

function formatDateTime(isoString) {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
    if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
    
    return date.toLocaleDateString();
}

function refreshAllDashboards() {
    loadSummaryData();
    switchCategory(currentCategory);
}

function toggleExportMenu() {
    document.getElementById('exportMenu').classList.toggle('show');
}

function exportReport(format) {
    alert(`Export to ${format.toUpperCase()} - Feature coming soon!`);
    document.getElementById('exportMenu').classList.remove('show');
}

// Close export menu when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.export-dropdown')) {
        document.getElementById('exportMenu')?.classList.remove('show');
    }
});
</script>
{% endblock %}