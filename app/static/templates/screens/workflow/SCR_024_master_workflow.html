{% extends "base.html" %}

{% block title %}Master Workflow Setup - CALIM 360{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #2762cb;
        --secondary-color: #73B4E0;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --text-color: #2c3e50;
        --text-muted: #6c757d;
        --border-color: #dee2e6;
        --background-light: #f8f9fa;
        --transition: all 0.3s ease;
    }

    /* Main Container */
    .workflow-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 2rem;
    }

    /* Page Header */
    .page-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 2rem;
        border-radius: 12px 12px 0 0;
        margin-bottom: 0;
    }

    .page-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 1.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .page-header p {
        margin: 0;
        opacity: 0.95;
        font-size: 0.95rem;
    }

    /* Alert */
    .alert {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin: 1.5rem 0;
        border-left: 4px solid;
    }

    .alert-info {
        background: #d1ecf1;
        border-color: #0c5460;
        color: #0c5460;
    }

    .alert i {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    /* Workflow Card */
    .workflow-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
    }

    .card-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-color);
    }

    .card-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .card-body {
        padding: 2rem;
    }

    /* Workflow Table */
    .workflow-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .workflow-table thead tr {
        background: var(--background-light);
        border-bottom: 2px solid var(--border-color);
    }

    .workflow-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--text-color);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .workflow-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: var(--transition);
    }

    .workflow-table tbody tr:hover {
        background: var(--background-light);
    }

    .workflow-table td {
        padding: 1.25rem 1rem;
        vertical-align: middle;
    }

    /* Step Number */
    .step-number {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
    }

    /* Form Elements */
    .form-select,
    .form-input {
        width: 100%;
        padding: 0.625rem 0.875rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.875rem;
        transition: var(--transition);
        background: white;
    }

    .form-select:focus,
    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    .form-input:disabled,
    .form-select:disabled {
        background: var(--background-light);
        cursor: not-allowed;
        color: var(--text-muted);
    }

    /* User Search & Dropdown */
    .user-selection-wrapper {
        position: relative;
    }

    .user-input-group {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .user-search-input {
        flex: 1;
        padding: 0.625rem 2.5rem 0.625rem 0.875rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.875rem;
        transition: var(--transition);
    }

    .user-search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(39, 98, 203, 0.1);
    }

    .user-search-input.has-value {
        background: var(--background-light);
        border-color: var(--success-color);
    }

    .search-icon {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
    }

    .clear-user-btn {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.25rem;
        display: none;
        font-size: 1rem;
        line-height: 1;
    }

    .user-search-input.has-value ~ .clear-user-btn {
        display: block;
    }

    .user-search-input.has-value ~ .search-icon {
        display: none;
    }

    .clear-user-btn:hover {
        color: var(--danger-color);
    }

    .user-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 4px;
    }

    .user-dropdown-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: var(--transition);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .user-dropdown-item:last-child {
        border-bottom: none;
    }

    .user-dropdown-item:hover {
        background: var(--background-light);
    }

    .user-dropdown-item .user-info strong {
        display: block;
        color: var(--text-color);
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .user-dropdown-item .user-info small {
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    .user-dropdown-item .user-badge {
        background: var(--secondary-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
    }

    .no-users-found {
        padding: 1rem;
        text-align: center;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    /* Remove Step Icon */
    .remove-step {
        color: var(--danger-color);
        cursor: pointer;
        font-size: 1.25rem;
        transition: var(--transition);
    }

    .remove-step:hover {
        transform: scale(1.15);
        opacity: 0.8;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 1rem;
        padding: 1.5rem 2rem;
        background: var(--background-light);
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 12px 12px;
        justify-content: flex-end;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: #1e4fb3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(39, 98, 203, 0.25);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
    }

    .btn-success:hover {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25);
    }

    /* Add Step Button */
    .add-step-btn {
        width: 100%;
        padding: 1rem;
        border: 2px dashed var(--border-color);
        background: transparent;
        color: var(--primary-color);
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-weight: 500;
    }

    .add-step-btn:hover {
        border-color: var(--primary-color);
        background: rgba(39, 98, 203, 0.05);
    }

    /* Department Badge */
    .department-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--background-light);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-color);
        font-size: 0.875rem;
    }

    .department-badge i {
        color: var(--primary-color);
    }

    /* Notification */
    .notification {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .notification.success {
        border-left: 4px solid var(--success-color);
    }

    .notification.error {
        border-left: 4px solid var(--danger-color);
    }

    .notification.warning {
        border-left: 4px solid var(--warning-color);
    }
</style>

<div class="workflow-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1>
            <i class="ti ti-git-branch"></i>
            Master Workflow Setup
        </h1>
        <p>
            Configure the default workflow for all contracts. This workflow will be applied company-wide unless overridden.
        </p>
    </div>

    <div class="alert alert-info">
        <i class="ti ti-info-circle"></i>
        <div>
            <strong>Important:</strong> The Master Workflow will be the default for all new contracts. Individual contracts can override this workflow if needed.
        </div>
    </div>

    <!-- Workflow Steps Configuration -->
    <div class="workflow-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="ti ti-git-branch"></i>
                Workflow Steps Configuration
            </h2>
        </div>
        <div class="card-body">
            <table class="workflow-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">Step</th>
                        <th>Role</th>
                        <th>User</th>
                        <th>Department</th>
                        <th style="width: 80px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="workflowSteps">
                    <!-- Steps will be rendered here by JavaScript -->
                </tbody>
            </table>

            <button class="add-step-btn" onclick="addWorkflowStep()">
                <i class="ti ti-plus"></i>
                Add Workflow Step
            </button>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="workflow-card">
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="saveWorkflow()">
                <i class="ti ti-device-floppy"></i>
                Save & Exit
            </button>
            <button class="btn btn-success" onclick="submitWorkflow()">
                <i class="ti ti-check"></i>
                Submit
            </button>
        </div>
    </div>
</div>

<script>
let workflowSteps = [];
let stepCount = 0;
let availableRoles = ['Reviewer', 'Approver', 'Legal Reviewer', 'Finance Approver', 'Director', 'E-Sign Authority', 'Counter-Party'];
let allUsers = []; // Store all users for quick lookup

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Master Workflow page loaded');
    loadAllUsers();
    loadWorkflowData();
});

// Load all users from the company
async function loadAllUsers() {
    try {
        const response = await fetch('/api/workflows/users/search?query=');
        if (response.ok) {
            const data = await response.json();
            allUsers = data.users || [];
            console.log(`‚úÖ Loaded ${allUsers.length} users`);
        }
    } catch (error) {
        console.error('‚ùå Error loading users:', error);
    }
}

// Load workflow data from API
async function loadWorkflowData() {
    try {
        const response = await fetch('/api/workflows/master');
        if (response.ok) {
            const data = await response.json();
            
            // Check if data is the workflow object directly or wrapped
            const workflow = data.workflow_name ? data : (data.workflow || null);
            
            if (workflow && workflow.steps && workflow.steps.length > 0) {
                console.log('üì• Loaded workflow from database:', workflow);
                populateWorkflowFromDatabase(workflow);
            } else {
                console.log('‚ÑπÔ∏è No existing workflow, rendering empty table');
                renderWorkflowSteps();
            }
        } else {
            console.log('‚ÑπÔ∏è No workflow found, starting fresh');
            renderWorkflowSteps();
        }
    } catch (error) {
        console.error('‚ùå Error loading workflow:', error);
        renderWorkflowSteps();
    }
}

// Populate workflow from database
function populateWorkflowFromDatabase(workflowData) {
    console.log('üîÑ Populating workflow from database');
    
    workflowSteps = [];
    stepCount = 0;

    if (workflowData.steps && workflowData.steps.length > 0) {
        workflowData.steps.forEach(step => {
            // Handle both formats - with users array or direct user_id
            let userId = null;
            let userName = '';
            let userEmail = '';
            let department = step.department || '';
            
            if (step.users && step.users.length > 0) {
                // Users array format
                const user = step.users[0];
                userId = user.id;
                userName = user.name;
                userEmail = user.email;
                department = step.department || user.department || '';
            } else if (step.assignee_user_id) {
                // Direct user_id format (from database response)
                userId = step.assignee_user_id;
                userName = step.user_name || '';
                userEmail = step.user_email || '';
                department = step.department || '';
            }
            
            workflowSteps.push({
                step_number: step.step_number,
                role: step.assignee_role || step.role || step.step_type || '',
                user_id: userId,
                user_name: userName,
                user_email: userEmail,
                department: department
            });
        });
        stepCount = workflowSteps.length;
        console.log(`‚úÖ Populated ${stepCount} steps:`, workflowSteps);
    }

    renderWorkflowSteps();
}

// Render workflow steps
function renderWorkflowSteps() {
    console.log('üé® Rendering workflow steps');
    const tbody = document.getElementById('workflowSteps');
    tbody.innerHTML = '';

    workflowSteps.forEach((step, index) => {
        tbody.appendChild(createStepRow(step, index));
    });

    console.log(`‚úÖ Rendered ${workflowSteps.length} workflow steps`);
}

// Create step row
function createStepRow(step, index) {
    const stepNum = index + 1;
    const tr = document.createElement('tr');
    tr.className = 'workflow-step';

    // Role options
    const roleOptions = availableRoles.map(role => 
        `<option value="${role}" ${step.role === role ? 'selected' : ''}>${role}</option>`
    ).join('');

    // User display value
    const userDisplayValue = step.user_name ? `${step.user_name} (${step.user_email})` : '';
    const hasUserClass = step.user_name ? 'has-value' : '';

    tr.innerHTML = `
        <td>
            <div class="step-number">${stepNum}</div>
        </td>
        <td>
            <select class="form-select" name="role_${stepNum}" onchange="updateStepRole(${index}, this.value)">
                <option value="">Select Role</option>
                ${roleOptions}
            </select>
        </td>
        <td>
            <div class="user-selection-wrapper">
                <div class="user-input-group">
                    <input 
                        type="text" 
                        class="user-search-input ${hasUserClass}" 
                        id="userSearch_${stepNum}"
                        placeholder="Search by name or email..." 
                        value="${userDisplayValue}"
                        onkeyup="searchUsers(${index}, this.value)"
                        onfocus="showUserDropdown(${index})"
                        autocomplete="off">
                    <i class="ti ti-search search-icon"></i>
                    <button type="button" class="clear-user-btn" onclick="clearUser(${index})">
                        <i class="ti ti-x"></i>
                    </button>
                </div>
                <div class="user-dropdown" id="userDropdown_${stepNum}" style="display: none;"></div>
            </div>
        </td>
        <td>
            <div class="department-badge" id="department_${stepNum}">
                <i class="ti ti-building"></i>
                <span>${step.department || 'Not assigned'}</span>
            </div>
        </td>
        <td style="text-align: center;">
            <i class="ti ti-trash remove-step" onclick="removeStep(${index})"></i>
        </td>
    `;

    return tr;
}

// Add new workflow step
function addWorkflowStep() {
    workflowSteps.push({
        step_number: workflowSteps.length + 1,
        role: '',
        user_id: null,
        user_name: '',
        user_email: '',
        department: ''
    });
    stepCount = workflowSteps.length;
    console.log('‚ûï Added new step. Total:', stepCount);
    renderWorkflowSteps();
}

// Remove step
function removeStep(index) {
    if (workflowSteps.length <= 1) {
        showNotification('At least one workflow step is required', 'warning');
        return;
    }

    if (confirm('Are you sure you want to remove this workflow step?')) {
        workflowSteps.splice(index, 1);
        // Renumber steps
        workflowSteps.forEach((step, idx) => {
            step.step_number = idx + 1;
        });
        stepCount = workflowSteps.length;
        console.log(`üóëÔ∏è Removed step. Total: ${stepCount}`);
        renderWorkflowSteps();
    }
}

// Update step role
function updateStepRole(index, role) {
    if (workflowSteps[index]) {
        workflowSteps[index].role = role;
        console.log(`‚úèÔ∏è Updated step ${index + 1} role to: ${role}`);
    }
}

// Search users
let searchTimeout;
window.searchUsers = function(index, query) {
    clearTimeout(searchTimeout);

    const stepNum = index + 1;
    const dropdown = document.getElementById(`userDropdown_${stepNum}`);
    
    if (!dropdown) return;

    // If query is empty and no user selected, hide dropdown
    if (!query.trim()) {
        if (!workflowSteps[index] || !workflowSteps[index].user_id) {
            hideUserDropdown(index);
        }
        return;
    }

    searchTimeout = setTimeout(() => {
        const filteredUsers = allUsers.filter(user => {
            const searchLower = query.toLowerCase();
            return user.name.toLowerCase().includes(searchLower) || 
                   user.email.toLowerCase().includes(searchLower);
        });

        displayUserDropdown(index, filteredUsers);
    }, 300);
};

// Show user dropdown
window.showUserDropdown = function(index) {
    const stepNum = index + 1;
    const input = document.getElementById(`userSearch_${stepNum}`);
    
    // If user already selected, don't show dropdown on focus
    if (workflowSteps[index] && workflowSteps[index].user_id && input && input.value) {
        return;
    }

    // Show all users if no search query
    displayUserDropdown(index, allUsers);
};

// Display user dropdown
function displayUserDropdown(index, users) {
    const stepNum = index + 1;
    const dropdown = document.getElementById(`userDropdown_${stepNum}`);
    
    if (!dropdown) return;

    if (users.length === 0) {
        dropdown.innerHTML = '<div class="no-users-found">No users found</div>';
        dropdown.style.display = 'block';
        return;
    }

    dropdown.innerHTML = users.map(user => {
        const userJson = JSON.stringify(user).replace(/"/g, '&quot;');
        return `
            <div class="user-dropdown-item" onclick="selectUser(${index}, JSON.parse(this.getAttribute('data-user')))" data-user="${userJson}">
                <div class="user-info">
                    <strong>${escapeHtml(user.name)}</strong>
                    <small>${escapeHtml(user.email)}</small>
                </div>
                <span class="user-badge">${escapeHtml(user.department || 'No Dept')}</span>
            </div>
        `;
    }).join('');

    dropdown.style.display = 'block';
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Hide user dropdown
function hideUserDropdown(index) {
    const stepNum = index + 1;
    const dropdown = document.getElementById(`userDropdown_${stepNum}`);
    if (dropdown) {
        setTimeout(() => {
            dropdown.style.display = 'none';
        }, 200);
    }
}

// Select user from dropdown
window.selectUser = function(index, user) {
    if (!workflowSteps[index]) return;

    workflowSteps[index].user_id = user.id;
    workflowSteps[index].user_name = user.name;
    workflowSteps[index].user_email = user.email;
    workflowSteps[index].department = user.department || '';

    console.log(`‚úèÔ∏è Updated step ${index + 1} user to: ${user.name} (${user.department})`);

    // Update department badge
    const stepNum = index + 1;
    const departmentBadge = document.getElementById(`department_${stepNum}`);
    if (departmentBadge) {
        const span = departmentBadge.querySelector('span');
        if (span) {
            span.textContent = user.department || 'Not assigned';
        }
    }

    // Update input field
    const input = document.getElementById(`userSearch_${stepNum}`);
    if (input) {
        input.value = `${user.name} (${user.email})`;
        input.classList.add('has-value');
    }

    // Hide dropdown
    hideUserDropdown(index);
};

// Clear selected user
window.clearUser = function(index) {
    if (!workflowSteps[index]) return;

    const stepNum = index + 1;

    // Clear user data
    workflowSteps[index].user_id = null;
    workflowSteps[index].user_name = '';
    workflowSteps[index].user_email = '';
    workflowSteps[index].department = '';

    // Clear input
    const input = document.getElementById(`userSearch_${stepNum}`);
    if (input) {
        input.value = '';
        input.classList.remove('has-value');
        input.focus();
    }

    // Clear department
    const departmentBadge = document.getElementById(`department_${stepNum}`);
    if (departmentBadge) {
        const span = departmentBadge.querySelector('span');
        if (span) {
            span.textContent = 'Not assigned';
        }
    }

    console.log(`üóëÔ∏è Cleared user for step ${stepNum}`);
};

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.user-selection-wrapper')) {
        document.querySelectorAll('.user-dropdown').forEach(dropdown => {
            dropdown.style.display = 'none';
        });
    }
});

// Save workflow
async function saveWorkflow() {
    if (!validateWorkflow()) return;

    const workflowData = collectWorkflowData();
    console.log('üíæ Saving workflow:', workflowData);
    console.log('üìã Steps data:', JSON.stringify(workflowData.steps, null, 2));

    try {
        const response = await fetch('/api/workflows/master', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(workflowData)
        });

        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Save successful:', result);
            showNotification('Master workflow saved successfully', 'success');
            
            // Reload the workflow data to show what was saved
            setTimeout(() => {
                loadWorkflowData();
            }, 500);
        } else {
            const error = await response.json();
            console.error('‚ùå Server error response:', error);
            showNotification('Error: ' + (error.detail || 'Failed to save workflow'), 'error');
        }
    } catch (error) {
        console.error('‚ùå Error:', error);
        showNotification('Error saving workflow. Please try again.', 'error');
    }
}

// Submit workflow
async function submitWorkflow() {
    if (!validateWorkflow()) return;

    if (confirm('Are you sure you want to submit this master workflow? It will be applied to all new contracts.')) {
        await saveWorkflow();
    }
}

// Validate workflow
function validateWorkflow() {
    if (workflowSteps.length === 0) {
        showNotification('Please add at least one workflow step', 'warning');
        return false;
    }

    for (let i = 0; i < workflowSteps.length; i++) {
        const step = workflowSteps[i];

        if (!step.role) {
            showNotification(`Please select a role for step ${i + 1}`, 'warning');
            return false;
        }

        if (!step.user_id) {
            showNotification(`Please select a user for step ${i + 1}`, 'warning');
            return false;
        }
    }

    return true;
}

// Collect workflow data
function collectWorkflowData() {
    return {
        workflow_name: "Master Workflow",
        description: "Company-wide default workflow",
        steps: workflowSteps.map(step => ({
            step_number: step.step_number,
            step_name: step.role || `Step ${step.step_number}`,
            step_type: step.role || 'reviewer',
            role: step.role,
            department: step.department || null,
            users: step.user_id ? [{
                id: step.user_id,
                name: step.user_name,
                email: step.user_email,
                department: step.department || null
            }] : [],
            sla_hours: 24,
            is_mandatory: true
        })),
        auto_escalation: false,
        escalation_hours: 48
    };
}

// Show notification
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="ti ti-${type === 'success' ? 'check' : type === 'error' ? 'x' : 'alert-triangle'}"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}